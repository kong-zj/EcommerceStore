{"version":3,"sources":["../../src/web-mercator-viewport.js"],"names":["createMat4","zoomToScale","pixelsToWorld","lngLatToWorld","worldToLngLat","worldToPixels","getProjectionMatrix","getDistanceScales","getViewMatrix","fitBounds","getBounds","mat4","vec2","vec3","WebMercatorViewport","width","height","latitude","longitude","zoom","pitch","bearing","altitude","position","nearZMultiplier","farZMultiplier","scale","Math","max","distanceScales","center","add","mul","unitsPerMeter","projectionMatrix","viewMatrix","meterOffset","_initMatrices","equals","bind","project","unproject","projectPosition","unprojectPosition","Object","freeze","vpm","multiply","viewProjectionMatrix","m","translate","mInverse","invert","Error","pixelProjectionMatrix","pixelUnprojectionMatrix","viewport","xyz","topLeft","worldPosition","coord","x","y","y2","length","targetZ","undefined","z","targetZWorld","X","Y","Z","Number","isFinite","metersPerUnit","lngLat","xy","pos","fromLocation","toLocation","negate","newCenter","getMapCenterByLngLatPosition","bounds","options","assign","corners","getBoundingRegion","west","min","map","p","east","south","north"],"mappings":"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","sourcesContent":["// View and Projection Matrix calculations for mapbox-js style map view properties\nimport {createMat4} from './math-utils';\n\nimport {\n  zoomToScale,\n  pixelsToWorld,\n  lngLatToWorld,\n  worldToLngLat,\n  worldToPixels,\n  getProjectionMatrix,\n  getDistanceScales,\n  getViewMatrix\n} from './web-mercator-utils';\nimport fitBounds from './fit-bounds';\nimport getBounds from './get-bounds';\n\nimport * as mat4 from 'gl-matrix/mat4';\nimport * as vec2 from 'gl-matrix/vec2';\nimport * as vec3 from 'gl-matrix/vec3';\n\nexport default class WebMercatorViewport {\n  // eslint-disable-next-line max-statements\n  constructor(\n    {\n      // Map state\n      width,\n      height,\n      latitude = 0,\n      longitude = 0,\n      zoom = 0,\n      pitch = 0,\n      bearing = 0,\n      altitude = 1.5,\n      position = null,\n      nearZMultiplier = 0.02,\n      farZMultiplier = 1.01\n    } = {width: 1, height: 1}\n  ) {\n    // Silently allow apps to send in 0,0 to facilitate isomorphic render etc\n    width = width || 1;\n    height = height || 1;\n\n    const scale = zoomToScale(zoom);\n    // Altitude - prevent division by 0\n    // TODO - just throw an Error instead?\n    altitude = Math.max(0.75, altitude);\n\n    const distanceScales = getDistanceScales({longitude, latitude});\n\n    const center = lngLatToWorld([longitude, latitude]);\n    center[2] = 0;\n\n    if (position) {\n      vec3.add(center, center, vec3.mul([], position, distanceScales.unitsPerMeter));\n    }\n\n    this.projectionMatrix = getProjectionMatrix({\n      width,\n      height,\n      pitch,\n      altitude,\n      nearZMultiplier,\n      farZMultiplier\n    });\n\n    this.viewMatrix = getViewMatrix({\n      height,\n      scale,\n      center,\n      pitch,\n      bearing,\n      altitude\n    });\n\n    // Save parameters\n    this.width = width;\n    this.height = height;\n    this.scale = scale;\n\n    this.latitude = latitude;\n    this.longitude = longitude;\n    this.zoom = zoom;\n    this.pitch = pitch;\n    this.bearing = bearing;\n    this.altitude = altitude;\n    this.center = center;\n    this.meterOffset = position || [0, 0, 0];\n\n    this.distanceScales = distanceScales;\n\n    this._initMatrices();\n\n    // Bind methods for easy access\n    this.equals = this.equals.bind(this);\n    this.project = this.project.bind(this);\n    this.unproject = this.unproject.bind(this);\n    this.projectPosition = this.projectPosition.bind(this);\n    this.unprojectPosition = this.unprojectPosition.bind(this);\n\n    Object.freeze(this);\n  }\n\n  _initMatrices() {\n    const {width, height, projectionMatrix, viewMatrix} = this;\n\n    // Note: As usual, matrix operations should be applied in \"reverse\" order\n    // since vectors will be multiplied in from the right during transformation\n    const vpm = createMat4();\n    mat4.multiply(vpm, vpm, projectionMatrix);\n    mat4.multiply(vpm, vpm, viewMatrix);\n    this.viewProjectionMatrix = vpm;\n\n    // Calculate matrices and scales needed for projection\n    /**\n     * Builds matrices that converts preprojected lngLats to screen pixels\n     * and vice versa.\n     * Note: Currently returns bottom-left coordinates!\n     * Note: Starts with the GL projection matrix and adds steps to the\n     *       scale and translate that matrix onto the window.\n     * Note: WebGL controls clip space to screen projection with gl.viewport\n     *       and does not need this step.\n     */\n    const m = createMat4();\n\n    // matrix for conversion from location to screen coordinates\n    mat4.scale(m, m, [width / 2, -height / 2, 1]);\n    mat4.translate(m, m, [1, -1, 0]);\n    mat4.multiply(m, m, vpm);\n\n    const mInverse = mat4.invert(createMat4(), m);\n    if (!mInverse) {\n      throw new Error('Pixel project matrix not invertible');\n    }\n\n    this.pixelProjectionMatrix = m;\n    this.pixelUnprojectionMatrix = mInverse;\n  }\n\n  // Two viewports are equal if width and height are identical, and if\n  // their view and projection matrices are (approximately) equal.\n  equals(viewport) {\n    if (!(viewport instanceof WebMercatorViewport)) {\n      return false;\n    }\n\n    return (\n      viewport.width === this.width &&\n      viewport.height === this.height &&\n      mat4.equals(viewport.projectionMatrix, this.projectionMatrix) &&\n      mat4.equals(viewport.viewMatrix, this.viewMatrix)\n    );\n  }\n\n  // Projects xyz (possibly latitude and longitude) to pixel coordinates in window\n  // using viewport projection parameters\n  project(xyz, {topLeft = true} = {}) {\n    const worldPosition = this.projectPosition(xyz);\n    const coord = worldToPixels(worldPosition, this.pixelProjectionMatrix);\n\n    const [x, y] = coord;\n    const y2 = topLeft ? y : this.height - y;\n    return xyz.length === 2 ? [x, y2] : [x, y2, coord[2]];\n  }\n\n  // Unproject pixel coordinates on screen onto world coordinates,\n  // (possibly [lon, lat]) on map.\n  unproject(xyz, {topLeft = true, targetZ = undefined} = {}) {\n    const [x, y, z] = xyz;\n\n    const y2 = topLeft ? y : this.height - y;\n    const targetZWorld = targetZ && targetZ * this.distanceScales.unitsPerMeter[2];\n    const coord = pixelsToWorld([x, y2, z], this.pixelUnprojectionMatrix, targetZWorld);\n    const [X, Y, Z] = this.unprojectPosition(coord);\n\n    if (Number.isFinite(z)) {\n      return [X, Y, Z];\n    }\n    return Number.isFinite(targetZ) ? [X, Y, targetZ] : [X, Y];\n  }\n\n  // NON_LINEAR PROJECTION HOOKS\n  // Used for web meractor projection\n\n  projectPosition(xyz) {\n    const [X, Y] = lngLatToWorld(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.unitsPerMeter[2];\n    return [X, Y, Z];\n  }\n\n  unprojectPosition(xyz) {\n    const [X, Y] = worldToLngLat(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.metersPerUnit[2];\n    return [X, Y, Z];\n  }\n\n  // Project [lng,lat] on sphere onto [x,y] on 512*512 Mercator Zoom 0 tile.\n  projectFlat(lngLat) {\n    return lngLatToWorld(lngLat);\n  }\n\n  // Unproject world point [x,y] on map onto {lat, lon} on sphere\n  unprojectFlat(xy) {\n    return worldToLngLat(xy);\n  }\n\n  // Get the map center that place a given [lng, lat] coordinate at screen point [x, y]\n  getMapCenterByLngLatPosition({lngLat, pos}) {\n    const fromLocation = pixelsToWorld(pos, this.pixelUnprojectionMatrix);\n    const toLocation = lngLatToWorld(lngLat);\n\n    const translate = vec2.add([], toLocation, vec2.negate([], fromLocation));\n    const newCenter = vec2.add([], this.center, translate);\n\n    return worldToLngLat(newCenter);\n  }\n\n  // Legacy method name\n  getLocationAtPoint({lngLat, pos}) {\n    return this.getMapCenterByLngLatPosition({lngLat, pos});\n  }\n\n  // Returns a new viewport that fit around the given rectangle.\n  fitBounds(bounds, options = {}) {\n    const {width, height} = this;\n    const {longitude, latitude, zoom} = fitBounds(Object.assign({width, height, bounds}, options));\n    return new WebMercatorViewport({width, height, longitude, latitude, zoom});\n  }\n\n  getBounds(options) {\n    const corners = this.getBoundingRegion(options);\n\n    const west = Math.min(...corners.map(p => p[0]));\n    const east = Math.max(...corners.map(p => p[0]));\n    const south = Math.min(...corners.map(p => p[1]));\n    const north = Math.max(...corners.map(p => p[1]));\n    return [[west, south], [east, north]];\n  }\n\n  getBoundingRegion(options = {}) {\n    return getBounds(this, options.z || 0);\n  }\n}\n"],"file":"web-mercator-viewport.js"}