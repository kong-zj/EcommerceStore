{"ast":null,"code":"const debug = require(\"debug\")(\"contract:execute\"); // eslint-disable-line no-unused-vars\n\n\nvar Web3PromiEvent = require(\"web3-core-promievent\");\n\nvar EventEmitter = require(\"events\");\n\nvar utils = require(\"./utils\");\n\nvar StatusError = require(\"./statuserror\");\n\nvar Reason = require(\"./reason\");\n\nvar handlers = require(\"./handlers\");\n\nvar override = require(\"./override\");\n\nvar reformat = require(\"./reformat\");\n\nvar execute = {\n  // -----------------------------------  Helpers --------------------------------------------------\n\n  /**\n   * Retrieves gas estimate multiplied by the set gas multiplier for a `sendTransaction` call.\n   * @param  {Object} params     `sendTransaction` parameters\n   * @param  {Number} blockLimit  most recent network block.blockLimit\n   * @return {Number}             gas estimate\n   */\n  getGasEstimate: function (params, blockLimit) {\n    var constructor = this;\n    var web3 = this.web3;\n    return new Promise(function (accept) {\n      // Always prefer specified gas - this includes gas set by class_defaults\n      if (params.gas) return accept(params.gas);\n      if (!constructor.autoGas) return accept();\n      web3.eth.estimateGas(params).then(gas => {\n        const bestEstimate = utils.multiplyBigNumberByDecimal(utils.bigNumberify(gas), constructor.gasMultiplier); // Don't go over blockLimit\n\n        const limit = utils.bigNumberify(blockLimit);\n        bestEstimate.gte(limit) ? accept(limit.sub(1).toHexString()) : accept(bestEstimate.toHexString()); // We need to let txs that revert through.\n        // Often that's exactly what you are testing.\n      }).catch(() => accept());\n    });\n  },\n\n  /**\n   * Prepares simple wrapped calls by checking network and organizing the method inputs into\n   * objects web3 can consume.\n   * @param  {Object} constructor   TruffleContract constructor\n   * @param  {Object} methodABI     Function ABI segment w/ inputs & outputs keys.\n   * @param  {Array}  _arguments    Arguments passed to method invocation\n   * @return {Promise}              Resolves object w/ tx params disambiguated from arguments\n   */\n  prepareCall: function (constructor, methodABI, _arguments) {\n    var args = Array.prototype.slice.call(_arguments);\n    var params = utils.getTxParams.call(constructor, methodABI, args);\n    args = utils.convertToEthersBN(args);\n    return constructor.detectNetwork().then(network => {\n      return {\n        args: args,\n        params: params,\n        network: network\n      };\n    });\n  },\n\n  /**\n   * Disambiguates between transaction parameter objects and BN / BigNumber objects\n   * @param  {Any}  arg\n   * @return {Boolean}\n   */\n  hasTxParams: function (arg) {\n    return utils.is_object(arg) && !utils.is_big_number(arg);\n  },\n\n  /**\n   * Parses function arguments to discover if the terminal argument specifies the `defaultBlock`\n   * to execute a call at.\n   * @param  {Array}  args      `arguments` that were passed to method\n   * @param  {Any}    lastArg    terminal argument passed to method\n   * @param  {Array}  inputs     ABI segment defining method arguments\n   * @return {Boolean}           true if final argument is `defaultBlock`\n   */\n  hasDefaultBlock: function (args, lastArg, inputs) {\n    var hasDefaultBlock = !execute.hasTxParams(lastArg) && args.length > inputs.length;\n    var hasDefaultBlockWithParams = execute.hasTxParams(lastArg) && args.length - 1 > inputs.length;\n    return hasDefaultBlock || hasDefaultBlockWithParams;\n  },\n  // -----------------------------------  Methods --------------------------------------------------\n\n  /**\n   * Executes method as .call and processes optional `defaultBlock` argument.\n   * @param  {Function} fn         method\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @return {Promise}             Return value of the call.\n   */\n  call: function (fn, methodABI, address) {\n    var constructor = this;\n    return function () {\n      var defaultBlock = \"latest\";\n      var args = Array.prototype.slice.call(arguments);\n      var lastArg = args[args.length - 1];\n      var promiEvent = new Web3PromiEvent(); // Extract defaultBlock parameter\n\n      if (execute.hasDefaultBlock(args, lastArg, methodABI.inputs)) {\n        defaultBlock = args.pop();\n      }\n\n      execute.prepareCall(constructor, methodABI, args).then(async ({\n        args,\n        params\n      }) => {\n        let result;\n        params.to = address;\n        promiEvent.eventEmitter.emit(\"execute:call:method\", {\n          fn: fn,\n          args: args,\n          address: address,\n          abi: methodABI,\n          contract: constructor\n        });\n        result = await fn(...args).call(params, defaultBlock);\n        result = reformat.numbers.call(constructor, result, methodABI.outputs);\n        return promiEvent.resolve(result);\n      }).catch(promiEvent.reject);\n      return promiEvent.eventEmitter;\n    };\n  },\n\n  /**\n   * Executes method as .send\n   * @param  {Function} fn         Method to invoke\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @param  {String}   address    Deployed address of the targeted instance\n   * @return {PromiEvent}          Resolves a transaction receipt (via the receipt handler)\n   */\n  send: function (fn, methodABI, address) {\n    var constructor = this;\n    var web3 = constructor.web3;\n    return function () {\n      var deferred;\n      var promiEvent = new Web3PromiEvent();\n      execute.prepareCall(constructor, methodABI, arguments).then(async ({\n        args,\n        params,\n        network\n      }) => {\n        var context = {\n          contract: constructor,\n          // Can't name this field `constructor` or `_constructor`\n          promiEvent: promiEvent,\n          params: params\n        };\n        params.to = address;\n        params.data = fn ? fn(...args).encodeABI() : params.data;\n        promiEvent.eventEmitter.emit(\"execute:send:method\", {\n          fn,\n          args,\n          address,\n          abi: methodABI,\n          contract: constructor\n        });\n\n        try {\n          params.gas = await execute.getGasEstimate.call(constructor, params, network.blockLimit);\n        } catch (error) {\n          promiEvent.reject(error);\n          return;\n        }\n\n        deferred = web3.eth.sendTransaction(params);\n        deferred.catch(override.start.bind(constructor, context));\n        handlers.setup(deferred, context);\n      }).catch(promiEvent.reject);\n      return promiEvent.eventEmitter;\n    };\n  },\n\n  /**\n   * Deploys an instance\n   * @param  {Object} constructorABI  Constructor ABI segment w/ inputs & outputs keys\n   * @return {PromiEvent}             Resolves a TruffleContract instance\n   */\n  deploy: function (constructorABI) {\n    var constructor = this;\n    var web3 = constructor.web3;\n    return function () {\n      var deferred;\n      const promiEvent = new Web3PromiEvent();\n      execute.prepareCall(constructor, constructorABI, arguments).then(async ({\n        args,\n        params,\n        network\n      }) => {\n        const {\n          blockLimit\n        } = network;\n        utils.checkLibraries.apply(constructor); // Promievent and flag that allows instance to resolve (rather than just receipt)\n\n        const context = {\n          contract: constructor,\n          promiEvent,\n          onlyEmitReceipt: true\n        };\n        var options = {\n          data: constructor.binary,\n          arguments: args\n        };\n        var contract = new web3.eth.Contract(constructor.abi);\n        params.data = contract.deploy(options).encodeABI();\n        params.gas = await execute.getGasEstimate.call(constructor, params, blockLimit);\n        context.params = params;\n        promiEvent.eventEmitter.emit(\"execute:deploy:method\", {\n          args,\n          abi: constructorABI,\n          contract: constructor\n        });\n        deferred = web3.eth.sendTransaction(params);\n        handlers.setup(deferred, context);\n\n        try {\n          const receipt = await deferred;\n\n          if (receipt.status !== undefined && !receipt.status) {\n            var reason = await Reason.get(params, web3);\n            var error = new StatusError(params, context.transactionHash, receipt, reason);\n            return context.promiEvent.reject(error);\n          }\n\n          var web3Instance = new web3.eth.Contract(constructor.abi, receipt.contractAddress);\n          web3Instance.transactionHash = context.transactionHash;\n          context.promiEvent.resolve(new constructor(web3Instance));\n        } catch (web3Error) {\n          // Manage web3's 50 blocks' timeout error.\n          // Web3's own subscriptions go dead here.\n          await override.start.call(constructor, context, web3Error);\n        }\n      }).catch(promiEvent.reject);\n      return promiEvent.eventEmitter;\n    };\n  },\n\n  /**\n   * Begins listening for an event OR manages the event callback\n   * @param  {Function} fn  Solidity event method\n   * @return {Emitter}      Event emitter\n   */\n  event: function (fn) {\n    var constructor = this;\n    var decode = utils.decodeLogs;\n    var currentLogID = null; // Someone upstream is firing duplicates :/\n\n    function dedupe(id) {\n      return id === currentLogID ? false : currentLogID = id;\n    }\n\n    return function (params, callback) {\n      if (typeof params === \"function\") {\n        callback = params;\n        params = {};\n      } // As callback\n\n\n      if (callback !== undefined) {\n        var intermediary = function (err, e) {\n          if (err) return callback(err);\n          if (!dedupe(e.id)) return;\n          callback(null, decode.call(constructor, e, true)[0]);\n        };\n\n        return constructor.detectNetwork().then(() => fn.call(constructor.events, params, intermediary));\n      } // As EventEmitter\n\n\n      var emitter = new EventEmitter();\n      constructor.detectNetwork().then(() => {\n        var event = fn(params);\n        event.on(\"data\", e => dedupe(e.id) && emitter.emit(\"data\", decode.call(constructor, e, true)[0]));\n        event.on(\"changed\", e => dedupe(e.id) && emitter.emit(\"changed\", decode.call(constructor, e, true)[0]));\n        event.on(\"error\", e => emitter.emit(\"error\", e));\n      });\n      return emitter;\n    };\n  },\n\n  /**\n   * Wraps web3 `allEvents`, with additional log decoding\n   * @return {PromiEvent}  EventEmitter\n   */\n  allEvents: function (web3Instance) {\n    var constructor = this;\n    var decode = utils.decodeLogs;\n    var currentLogID = null; // Someone upstream is firing duplicates :/\n\n    function dedupe(id) {\n      return id === currentLogID ? false : currentLogID = id;\n    }\n\n    return function (params) {\n      var emitter = new EventEmitter();\n      constructor.detectNetwork().then(() => {\n        var event = web3Instance.events.allEvents(params);\n        event.on(\"data\", e => dedupe(e.id) && emitter.emit(\"data\", decode.call(constructor, e, true)[0]));\n        event.on(\"changed\", e => dedupe(e.id) && emitter.emit(\"changed\", decode.call(constructor, e, true)[0]));\n        event.on(\"error\", e => emitter.emit(\"error\", e));\n      });\n      return emitter;\n    };\n  },\n\n  /**\n   * Wraps web3 `getPastEvents`, with additional log decoding\n   * @return {Promise}  Resolves array of event objects\n   */\n  getPastEvents: function (web3Instance) {\n    var constructor = this;\n    var decode = utils.decodeLogs;\n    return function (event, options) {\n      return web3Instance.getPastEvents(event, options).then(events => decode.call(constructor, events, false));\n    };\n  },\n\n  /**\n   * Estimates gas cost of a method invocation\n   * @param  {Function} fn  Method to target\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @return {Promise}\n   */\n  estimate: function (fn, methodABI) {\n    var constructor = this;\n    return function () {\n      return execute.prepareCall(constructor, methodABI, arguments).then(res => fn(...res.args).estimateGas(res.params));\n    };\n  },\n\n  /**\n   *\n   * @param  {Function} fn  Method to target\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @return {Promise}\n   */\n  request: function (fn, methodABI) {\n    var constructor = this;\n    return function () {\n      return execute.prepareCall(constructor, methodABI, arguments).then(res => fn(...res.args).request(res.params));\n    };\n  },\n  // This gets attached to `.new` (declared as a static_method in `contract`)\n  // during bootstrapping as `estimate`\n  estimateDeployment: function () {\n    var constructor = this;\n    var constructorABI = constructor.abi.filter(i => i.type === \"constructor\")[0];\n    return execute.prepareCall(constructor, constructorABI, arguments).then(res => {\n      var options = {\n        data: constructor.binary,\n        arguments: res.args\n      };\n      delete res.params[\"data\"]; // Is this necessary?\n\n      var instance = new constructor.web3.eth.Contract(constructor.abi, res.params);\n      return instance.deploy(options).estimateGas(res.params);\n    });\n  }\n};\nmodule.exports = execute;","map":{"version":3,"sources":["/home/kzj/project/finalize/final/code/react_code/node_modules/truffle-contract/lib/execute.js"],"names":["debug","require","Web3PromiEvent","EventEmitter","utils","StatusError","Reason","handlers","override","reformat","execute","getGasEstimate","params","blockLimit","constructor","web3","Promise","accept","gas","autoGas","eth","estimateGas","then","bestEstimate","multiplyBigNumberByDecimal","bigNumberify","gasMultiplier","limit","gte","sub","toHexString","catch","prepareCall","methodABI","_arguments","args","Array","prototype","slice","call","getTxParams","convertToEthersBN","detectNetwork","network","hasTxParams","arg","is_object","is_big_number","hasDefaultBlock","lastArg","inputs","length","hasDefaultBlockWithParams","fn","address","defaultBlock","arguments","promiEvent","pop","result","to","eventEmitter","emit","abi","contract","numbers","outputs","resolve","reject","send","deferred","context","data","encodeABI","error","sendTransaction","start","bind","setup","deploy","constructorABI","checkLibraries","apply","onlyEmitReceipt","options","binary","Contract","receipt","status","undefined","reason","get","transactionHash","web3Instance","contractAddress","web3Error","event","decode","decodeLogs","currentLogID","dedupe","id","callback","intermediary","err","e","events","emitter","on","allEvents","getPastEvents","estimate","res","request","estimateDeployment","filter","i","type","instance","module","exports"],"mappings":"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","sourcesContent":["const debug = require(\"debug\")(\"contract:execute\"); // eslint-disable-line no-unused-vars\nvar Web3PromiEvent = require(\"web3-core-promievent\");\nvar EventEmitter = require(\"events\");\nvar utils = require(\"./utils\");\nvar StatusError = require(\"./statuserror\");\nvar Reason = require(\"./reason\");\nvar handlers = require(\"./handlers\");\nvar override = require(\"./override\");\nvar reformat = require(\"./reformat\");\n\nvar execute = {\n  // -----------------------------------  Helpers --------------------------------------------------\n  /**\n   * Retrieves gas estimate multiplied by the set gas multiplier for a `sendTransaction` call.\n   * @param  {Object} params     `sendTransaction` parameters\n   * @param  {Number} blockLimit  most recent network block.blockLimit\n   * @return {Number}             gas estimate\n   */\n  getGasEstimate: function(params, blockLimit) {\n    var constructor = this;\n    var web3 = this.web3;\n\n    return new Promise(function(accept) {\n      // Always prefer specified gas - this includes gas set by class_defaults\n      if (params.gas) return accept(params.gas);\n      if (!constructor.autoGas) return accept();\n\n      web3.eth\n        .estimateGas(params)\n        .then(gas => {\n          const bestEstimate = utils.multiplyBigNumberByDecimal(\n            utils.bigNumberify(gas),\n            constructor.gasMultiplier\n          );\n\n          // Don't go over blockLimit\n          const limit = utils.bigNumberify(blockLimit);\n          bestEstimate.gte(limit)\n            ? accept(limit.sub(1).toHexString())\n            : accept(bestEstimate.toHexString());\n\n          // We need to let txs that revert through.\n          // Often that's exactly what you are testing.\n        })\n        .catch(() => accept());\n    });\n  },\n\n  /**\n   * Prepares simple wrapped calls by checking network and organizing the method inputs into\n   * objects web3 can consume.\n   * @param  {Object} constructor   TruffleContract constructor\n   * @param  {Object} methodABI     Function ABI segment w/ inputs & outputs keys.\n   * @param  {Array}  _arguments    Arguments passed to method invocation\n   * @return {Promise}              Resolves object w/ tx params disambiguated from arguments\n   */\n  prepareCall: function(constructor, methodABI, _arguments) {\n    var args = Array.prototype.slice.call(_arguments);\n    var params = utils.getTxParams.call(constructor, methodABI, args);\n\n    args = utils.convertToEthersBN(args);\n\n    return constructor.detectNetwork().then(network => {\n      return { args: args, params: params, network: network };\n    });\n  },\n\n  /**\n   * Disambiguates between transaction parameter objects and BN / BigNumber objects\n   * @param  {Any}  arg\n   * @return {Boolean}\n   */\n  hasTxParams: function(arg) {\n    return utils.is_object(arg) && !utils.is_big_number(arg);\n  },\n\n  /**\n   * Parses function arguments to discover if the terminal argument specifies the `defaultBlock`\n   * to execute a call at.\n   * @param  {Array}  args      `arguments` that were passed to method\n   * @param  {Any}    lastArg    terminal argument passed to method\n   * @param  {Array}  inputs     ABI segment defining method arguments\n   * @return {Boolean}           true if final argument is `defaultBlock`\n   */\n  hasDefaultBlock: function(args, lastArg, inputs) {\n    var hasDefaultBlock =\n      !execute.hasTxParams(lastArg) && args.length > inputs.length;\n    var hasDefaultBlockWithParams =\n      execute.hasTxParams(lastArg) && args.length - 1 > inputs.length;\n    return hasDefaultBlock || hasDefaultBlockWithParams;\n  },\n\n  // -----------------------------------  Methods --------------------------------------------------\n\n  /**\n   * Executes method as .call and processes optional `defaultBlock` argument.\n   * @param  {Function} fn         method\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @return {Promise}             Return value of the call.\n   */\n  call: function(fn, methodABI, address) {\n    var constructor = this;\n\n    return function() {\n      var defaultBlock = \"latest\";\n      var args = Array.prototype.slice.call(arguments);\n      var lastArg = args[args.length - 1];\n      var promiEvent = new Web3PromiEvent();\n\n      // Extract defaultBlock parameter\n      if (execute.hasDefaultBlock(args, lastArg, methodABI.inputs)) {\n        defaultBlock = args.pop();\n      }\n\n      execute\n        .prepareCall(constructor, methodABI, args)\n        .then(async ({ args, params }) => {\n          let result;\n\n          params.to = address;\n\n          promiEvent.eventEmitter.emit(\"execute:call:method\", {\n            fn: fn,\n            args: args,\n            address: address,\n            abi: methodABI,\n            contract: constructor\n          });\n\n          result = await fn(...args).call(params, defaultBlock);\n          result = reformat.numbers.call(\n            constructor,\n            result,\n            methodABI.outputs\n          );\n          return promiEvent.resolve(result);\n        })\n        .catch(promiEvent.reject);\n\n      return promiEvent.eventEmitter;\n    };\n  },\n\n  /**\n   * Executes method as .send\n   * @param  {Function} fn         Method to invoke\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @param  {String}   address    Deployed address of the targeted instance\n   * @return {PromiEvent}          Resolves a transaction receipt (via the receipt handler)\n   */\n  send: function(fn, methodABI, address) {\n    var constructor = this;\n    var web3 = constructor.web3;\n\n    return function() {\n      var deferred;\n      var promiEvent = new Web3PromiEvent();\n\n      execute\n        .prepareCall(constructor, methodABI, arguments)\n        .then(async ({ args, params, network }) => {\n          var context = {\n            contract: constructor, // Can't name this field `constructor` or `_constructor`\n            promiEvent: promiEvent,\n            params: params\n          };\n\n          params.to = address;\n          params.data = fn ? fn(...args).encodeABI() : params.data;\n\n          promiEvent.eventEmitter.emit(\"execute:send:method\", {\n            fn,\n            args,\n            address,\n            abi: methodABI,\n            contract: constructor\n          });\n\n          try {\n            params.gas = await execute.getGasEstimate.call(\n              constructor,\n              params,\n              network.blockLimit\n            );\n          } catch (error) {\n            promiEvent.reject(error);\n            return;\n          }\n\n          deferred = web3.eth.sendTransaction(params);\n          deferred.catch(override.start.bind(constructor, context));\n          handlers.setup(deferred, context);\n        })\n        .catch(promiEvent.reject);\n\n      return promiEvent.eventEmitter;\n    };\n  },\n\n  /**\n   * Deploys an instance\n   * @param  {Object} constructorABI  Constructor ABI segment w/ inputs & outputs keys\n   * @return {PromiEvent}             Resolves a TruffleContract instance\n   */\n  deploy: function(constructorABI) {\n    var constructor = this;\n    var web3 = constructor.web3;\n\n    return function() {\n      var deferred;\n      const promiEvent = new Web3PromiEvent();\n\n      execute\n        .prepareCall(constructor, constructorABI, arguments)\n        .then(async ({ args, params, network }) => {\n          const { blockLimit } = network;\n\n          utils.checkLibraries.apply(constructor);\n\n          // Promievent and flag that allows instance to resolve (rather than just receipt)\n          const context = {\n            contract: constructor,\n            promiEvent,\n            onlyEmitReceipt: true\n          };\n\n          var options = {\n            data: constructor.binary,\n            arguments: args\n          };\n\n          var contract = new web3.eth.Contract(constructor.abi);\n          params.data = contract.deploy(options).encodeABI();\n\n          params.gas = await execute.getGasEstimate.call(\n            constructor,\n            params,\n            blockLimit\n          );\n\n          context.params = params;\n\n          promiEvent.eventEmitter.emit(\"execute:deploy:method\", {\n            args,\n            abi: constructorABI,\n            contract: constructor\n          });\n\n          deferred = web3.eth.sendTransaction(params);\n          handlers.setup(deferred, context);\n\n          try {\n            const receipt = await deferred;\n            if (receipt.status !== undefined && !receipt.status) {\n              var reason = await Reason.get(params, web3);\n\n              var error = new StatusError(\n                params,\n                context.transactionHash,\n                receipt,\n                reason\n              );\n\n              return context.promiEvent.reject(error);\n            }\n\n            var web3Instance = new web3.eth.Contract(\n              constructor.abi,\n              receipt.contractAddress\n            );\n            web3Instance.transactionHash = context.transactionHash;\n\n            context.promiEvent.resolve(new constructor(web3Instance));\n          } catch (web3Error) {\n            // Manage web3's 50 blocks' timeout error.\n            // Web3's own subscriptions go dead here.\n            await override.start.call(constructor, context, web3Error);\n          }\n        })\n        .catch(promiEvent.reject);\n\n      return promiEvent.eventEmitter;\n    };\n  },\n\n  /**\n   * Begins listening for an event OR manages the event callback\n   * @param  {Function} fn  Solidity event method\n   * @return {Emitter}      Event emitter\n   */\n  event: function(fn) {\n    var constructor = this;\n    var decode = utils.decodeLogs;\n    var currentLogID = null;\n\n    // Someone upstream is firing duplicates :/\n    function dedupe(id) {\n      return id === currentLogID ? false : (currentLogID = id);\n    }\n\n    return function(params, callback) {\n      if (typeof params === \"function\") {\n        callback = params;\n        params = {};\n      }\n\n      // As callback\n      if (callback !== undefined) {\n        var intermediary = function(err, e) {\n          if (err) return callback(err);\n          if (!dedupe(e.id)) return;\n          callback(null, decode.call(constructor, e, true)[0]);\n        };\n\n        return constructor\n          .detectNetwork()\n          .then(() => fn.call(constructor.events, params, intermediary));\n      }\n\n      // As EventEmitter\n      var emitter = new EventEmitter();\n\n      constructor.detectNetwork().then(() => {\n        var event = fn(params);\n\n        event.on(\n          \"data\",\n          e =>\n            dedupe(e.id) &&\n            emitter.emit(\"data\", decode.call(constructor, e, true)[0])\n        );\n        event.on(\n          \"changed\",\n          e =>\n            dedupe(e.id) &&\n            emitter.emit(\"changed\", decode.call(constructor, e, true)[0])\n        );\n        event.on(\"error\", e => emitter.emit(\"error\", e));\n      });\n\n      return emitter;\n    };\n  },\n\n  /**\n   * Wraps web3 `allEvents`, with additional log decoding\n   * @return {PromiEvent}  EventEmitter\n   */\n  allEvents: function(web3Instance) {\n    var constructor = this;\n    var decode = utils.decodeLogs;\n    var currentLogID = null;\n\n    // Someone upstream is firing duplicates :/\n    function dedupe(id) {\n      return id === currentLogID ? false : (currentLogID = id);\n    }\n\n    return function(params) {\n      var emitter = new EventEmitter();\n\n      constructor.detectNetwork().then(() => {\n        var event = web3Instance.events.allEvents(params);\n\n        event.on(\n          \"data\",\n          e =>\n            dedupe(e.id) &&\n            emitter.emit(\"data\", decode.call(constructor, e, true)[0])\n        );\n        event.on(\n          \"changed\",\n          e =>\n            dedupe(e.id) &&\n            emitter.emit(\"changed\", decode.call(constructor, e, true)[0])\n        );\n        event.on(\"error\", e => emitter.emit(\"error\", e));\n      });\n\n      return emitter;\n    };\n  },\n\n  /**\n   * Wraps web3 `getPastEvents`, with additional log decoding\n   * @return {Promise}  Resolves array of event objects\n   */\n  getPastEvents: function(web3Instance) {\n    var constructor = this;\n    var decode = utils.decodeLogs;\n\n    return function(event, options) {\n      return web3Instance\n        .getPastEvents(event, options)\n        .then(events => decode.call(constructor, events, false));\n    };\n  },\n\n  /**\n   * Estimates gas cost of a method invocation\n   * @param  {Function} fn  Method to target\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @return {Promise}\n   */\n  estimate: function(fn, methodABI) {\n    var constructor = this;\n    return function() {\n      return execute\n        .prepareCall(constructor, methodABI, arguments)\n        .then(res => fn(...res.args).estimateGas(res.params));\n    };\n  },\n\n  /**\n   *\n   * @param  {Function} fn  Method to target\n   * @param  {Object}   methodABI  Function ABI segment w/ inputs & outputs keys.\n   * @return {Promise}\n   */\n  request: function(fn, methodABI) {\n    var constructor = this;\n    return function() {\n      return execute\n        .prepareCall(constructor, methodABI, arguments)\n        .then(res => fn(...res.args).request(res.params));\n    };\n  },\n\n  // This gets attached to `.new` (declared as a static_method in `contract`)\n  // during bootstrapping as `estimate`\n  estimateDeployment: function() {\n    var constructor = this;\n\n    var constructorABI = constructor.abi.filter(\n      i => i.type === \"constructor\"\n    )[0];\n\n    return execute\n      .prepareCall(constructor, constructorABI, arguments)\n      .then(res => {\n        var options = {\n          data: constructor.binary,\n          arguments: res.args\n        };\n\n        delete res.params[\"data\"]; // Is this necessary?\n\n        var instance = new constructor.web3.eth.Contract(\n          constructor.abi,\n          res.params\n        );\n        return instance.deploy(options).estimateGas(res.params);\n      });\n  }\n};\n\nmodule.exports = execute;\n"]},"metadata":{},"sourceType":"script"}