{"ast":null,"code":"import \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport \"antd/es/popconfirm/style\";\nimport _Popconfirm from \"antd/es/popconfirm\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _toArray from \"@babel/runtime/helpers/esm/toArray\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport _typeof from \"@babel/runtime/helpers/esm/typeof\";\nvar _excluded = [\"map_row_parentKey\", \"map_row_key\"],\n    _excluded2 = [\"map_row_key\"];\n/* eslint-disable react-hooks/exhaustive-deps */\n\nimport React, { useContext, useMemo, useRef, useState } from 'react';\nimport useMergedState from \"rc-util/es/hooks/useMergedState\";\nimport useLazyKVMap from \"antd/es/table/hooks/useLazyKVMap\";\nimport { LoadingOutlined } from '@ant-design/icons';\nimport { useIntl } from '@ant-design/pro-provider';\nimport set from \"rc-util/es/utils/set\";\nimport useMountMergeState from '../useMountMergeState';\nimport ProFormContext from '../components/ProFormContext';\nimport { merge } from '../merge';\nimport usePrevious from '../hooks/usePrevious';\nimport get from \"rc-util/es/utils/get\";\nimport { useDeepCompareEffectDebounce } from '../hooks/useDeepCompareEffect';\nimport { useDebounceFn, useRefFunction } from '..';\nexport var recordKeyToString = function recordKeyToString(rowKey) {\n  if (Array.isArray(rowKey)) return rowKey.join(',');\n  return rowKey;\n};\n/**\n * 使用map 来删除数据，性能一般 但是准确率比较高\n *\n * @param params\n * @param action\n */\n\nexport function editableRowByKey(params, action) {\n  var _recordKeyToString;\n\n  var getRowKey = params.getRowKey,\n      row = params.row,\n      data = params.data,\n      childrenColumnName = params.childrenColumnName;\n  var key = (_recordKeyToString = recordKeyToString(params.key)) === null || _recordKeyToString === void 0 ? void 0 : _recordKeyToString.toString();\n  var kvMap = new Map();\n  /**\n   * 打平这个数组\n   *\n   * @param records\n   * @param parentKey\n   */\n\n  function dig(records, map_row_parentKey, map_row_index) {\n    records.forEach(function (record, index) {\n      var eachIndex = (map_row_index || 0) * 10 + index;\n      var recordKey = getRowKey(record, eachIndex).toString(); // children 取在前面方便拼的时候按照反顺序放回去\n\n      if (record && _typeof(record) === 'object' && childrenColumnName in record) {\n        dig(record[childrenColumnName] || [], recordKey, eachIndex);\n      }\n\n      var newRecord = _objectSpread(_objectSpread({}, record), {}, {\n        map_row_key: recordKey,\n        children: undefined,\n        map_row_parentKey: map_row_parentKey\n      });\n\n      delete newRecord.children;\n\n      if (!map_row_parentKey) {\n        delete newRecord.map_row_parentKey;\n      }\n\n      kvMap.set(recordKey, newRecord);\n    });\n  }\n\n  if (action === 'top') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  dig(data);\n\n  if (action === 'update') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  if (action === 'delete') {\n    kvMap.delete(key);\n  }\n\n  var fill = function fill(map) {\n    var kvArrayMap = new Map();\n    var kvSource = [];\n    map.forEach(function (value) {\n      if (value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_parentKey = value.map_row_parentKey,\n            map_row_key = value.map_row_key,\n            reset = _objectWithoutProperties(value, _excluded);\n\n        if (kvArrayMap.has(map_row_key)) {\n          reset[childrenColumnName] = kvArrayMap.get(map_row_key);\n        }\n\n        kvArrayMap.set(map_row_parentKey, [].concat(_toConsumableArray(kvArrayMap.get(map_row_parentKey) || []), [reset]));\n      }\n    });\n    map.forEach(function (value) {\n      if (!value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_key = value.map_row_key,\n            rest = _objectWithoutProperties(value, _excluded2);\n\n        if (kvArrayMap.has(map_row_key)) {\n          var item = _objectSpread(_objectSpread({}, rest), {}, _defineProperty({}, childrenColumnName, kvArrayMap.get(map_row_key)));\n\n          kvSource.push(item);\n          return;\n        }\n\n        kvSource.push(rest);\n      }\n    });\n    return kvSource;\n  };\n\n  var source = fill(kvMap);\n  return source;\n}\n/**\n * 保存按钮的dom\n *\n * @param ActionRenderConfig\n */\n\nexport function SaveEditableAction(_ref) {\n  var recordKey = _ref.recordKey,\n      onSave = _ref.onSave,\n      form = _ref.form,\n      row = _ref.row,\n      children = _ref.children,\n      newLineConfig = _ref.newLineConfig,\n      editorType = _ref.editorType,\n      tableName = _ref.tableName;\n  var context = useContext(ProFormContext);\n\n  var _useMountMergeState = useMountMergeState(false),\n      _useMountMergeState2 = _slicedToArray(_useMountMergeState, 2),\n      loading = _useMountMergeState2[0],\n      setLoading = _useMountMergeState2[1];\n\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"save\",\n    onClick: /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(e) {\n        var _context$getFieldForm, isMapEditor, namePath, fields, _recordKey, recordKeyPath, curValue, data, res;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                _context.prev = 2;\n                isMapEditor = editorType === 'Map'; // 为了兼容类型为 array 的 dataIndex,当 recordKey 是一个数组时，用于获取表单值的 key 只取第一项，\n                // 从表单中获取回来之后，再根据 namepath 获取具体的某个字段并设置\n\n                namePath = [tableName, Array.isArray(recordKey) ? recordKey[0] : recordKey].map(function (key) {\n                  return key === null || key === void 0 ? void 0 : key.toString();\n                }).flat(1).filter(Boolean);\n                setLoading(true); // @ts-expect-error\n\n                _context.next = 8;\n                return form.validateFields(namePath, {\n                  recursive: true\n                });\n\n              case 8:\n                fields = ((_context$getFieldForm = context.getFieldFormatValue) === null || _context$getFieldForm === void 0 ? void 0 : _context$getFieldForm.call(context, namePath)) || form.getFieldValue(namePath); // 处理 dataIndex 为数组的情况\n\n                if (Array.isArray(recordKey) && recordKey.length > 1) {\n                  // 获取 namepath\n                  _recordKey = _toArray(recordKey), recordKeyPath = _recordKey.slice(1); // 将目标值获取出来并设置到 fields 当中\n\n                  curValue = get(fields, recordKeyPath);\n                  set(fields, recordKeyPath, curValue);\n                }\n\n                data = isMapEditor ? set({}, namePath, fields, true) : fields; // 获取数据并保存\n\n                _context.next = 13;\n                return onSave === null || onSave === void 0 ? void 0 : onSave(recordKey, // 如果是 map 模式，fields 就是一个值，所以需要set 到对象中\n                // 数据模式 fields 是一个对象，所以不需要\n                merge({}, row, data), row, newLineConfig);\n\n              case 13:\n                res = _context.sent;\n                setLoading(false);\n                return _context.abrupt(\"return\", res);\n\n              case 18:\n                _context.prev = 18;\n                _context.t0 = _context[\"catch\"](2); // eslint-disable-next-line no-console\n\n                console.log(_context.t0);\n                setLoading(false);\n                return _context.abrupt(\"return\", null);\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[2, 18]]);\n      }));\n\n      return function (_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }()\n  }, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '保存');\n}\n/**\n * 删除按钮 dom\n *\n * @param ActionRenderConfig\n */\n\nexport var DeleteEditableAction = function DeleteEditableAction(_ref3) {\n  var recordKey = _ref3.recordKey,\n      onDelete = _ref3.onDelete,\n      row = _ref3.row,\n      children = _ref3.children,\n      deletePopconfirmMessage = _ref3.deletePopconfirmMessage,\n      cancelEditable = _ref3.cancelEditable;\n\n  var _useMountMergeState3 = useMountMergeState(function () {\n    return false;\n  }),\n      _useMountMergeState4 = _slicedToArray(_useMountMergeState3, 2),\n      loading = _useMountMergeState4[0],\n      setLoading = _useMountMergeState4[1];\n\n  var onConfirm = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var res;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              setLoading(true);\n              _context2.next = 4;\n              return onDelete === null || onDelete === void 0 ? void 0 : onDelete(recordKey, row);\n\n            case 4:\n              res = _context2.sent;\n              setLoading(false);\n              setTimeout(function () {\n                cancelEditable(recordKey);\n              }, 0);\n              return _context2.abrupt(\"return\", res);\n\n            case 10:\n              _context2.prev = 10;\n              _context2.t0 = _context2[\"catch\"](0); // eslint-disable-next-line no-console\n\n              console.log(_context2.t0);\n              setLoading(false);\n              return _context2.abrupt(\"return\", null);\n\n            case 15:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 10]]);\n    }));\n\n    return function onConfirm() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  return children !== false ? /*#__PURE__*/React.createElement(_Popconfirm, {\n    key: \"delete\",\n    title: deletePopconfirmMessage,\n    onConfirm: onConfirm\n  }, /*#__PURE__*/React.createElement(\"a\", null, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '删除')) : null;\n};\n\nvar CancelEditableAction = function CancelEditableAction(props) {\n  var recordKey = props.recordKey,\n      tableName = props.tableName,\n      newLineConfig = props.newLineConfig,\n      form = props.form,\n      editorType = props.editorType,\n      onCancel = props.onCancel,\n      cancelEditable = props.cancelEditable,\n      row = props.row,\n      cancelText = props.cancelText;\n  var context = useContext(ProFormContext);\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"cancel\",\n    onClick: /*#__PURE__*/function () {\n      var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(e) {\n        var _context$getFieldForm2;\n\n        var isMapEditor, namePath, fields, record, res;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                isMapEditor = editorType === 'Map';\n                namePath = [tableName, recordKey].flat(1).filter(Boolean);\n                fields = ((_context$getFieldForm2 = context.getFieldFormatValue) === null || _context$getFieldForm2 === void 0 ? void 0 : _context$getFieldForm2.call(context, namePath)) || form.getFieldValue(namePath);\n                record = isMapEditor ? set({}, namePath, fields) : fields;\n                _context3.next = 8;\n                return onCancel === null || onCancel === void 0 ? void 0 : onCancel(recordKey, record, row, newLineConfig);\n\n              case 8:\n                res = _context3.sent;\n                cancelEditable(recordKey);\n                /** 充值为默认值，不然编辑的行会丢掉 */\n\n                form.setFieldsValue(_defineProperty({}, recordKey, isMapEditor ? get(row, namePath) : row));\n                return _context3.abrupt(\"return\", res);\n\n              case 12:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function (_x2) {\n        return _ref5.apply(this, arguments);\n      };\n    }()\n  }, cancelText || '取消');\n};\n\nexport function defaultActionRender(row, config) {\n  var recordKey = config.recordKey,\n      newLineConfig = config.newLineConfig,\n      saveText = config.saveText,\n      deleteText = config.deleteText;\n  return [/*#__PURE__*/React.createElement(SaveEditableAction, _extends({\n    key: \"save\"\n  }, config, {\n    row: row\n  }), saveText), (newLineConfig === null || newLineConfig === void 0 ? void 0 : newLineConfig.options.recordKey) !== recordKey ? /*#__PURE__*/React.createElement(DeleteEditableAction, _extends({\n    key: \"delete\"\n  }, config, {\n    row: row\n  }), deleteText) : null, /*#__PURE__*/React.createElement(CancelEditableAction, _extends({\n    key: \"cancel\"\n  }, config, {\n    row: row\n  }))];\n}\n/**\n * 一个方便的hooks 用于维护编辑的状态\n *\n * @param props\n */\n\nfunction useEditableArray(props) {\n  var _useState = useState(undefined),\n      _useState2 = _slicedToArray(_useState, 2),\n      newLineRecordCache = _useState2[0],\n      setNewLineRecordCache = _useState2[1];\n\n  var dataSourceKeyIndexMapRef = useRef(new Map());\n  var newLineRecordRef = useRef(undefined);\n  useDeepCompareEffectDebounce(function () {\n    var _props$dataSource;\n\n    var map = new Map();\n    (_props$dataSource = props.dataSource) === null || _props$dataSource === void 0 ? void 0 : _props$dataSource.forEach(function (record, index) {\n      var _recordKeyToString2;\n\n      map.set(index.toString(), recordKeyToString(props.getRowKey(record, -1)));\n      map.set((_recordKeyToString2 = recordKeyToString(props.getRowKey(record, -1))) === null || _recordKeyToString2 === void 0 ? void 0 : _recordKeyToString2.toString(), index.toString());\n    });\n    dataSourceKeyIndexMapRef.current = map;\n  }, [props.dataSource]); // 这里这么做是为了存上次的状态，不然每次存一下再拿\n\n  newLineRecordRef.current = newLineRecordCache;\n  var editableType = props.type || 'single';\n\n  var _useLazyKVMap = useLazyKVMap(props.dataSource, 'children', props.getRowKey),\n      _useLazyKVMap2 = _slicedToArray(_useLazyKVMap, 1),\n      getRecordByKey = _useLazyKVMap2[0];\n\n  var _useMergedState = useMergedState([], {\n    value: props.editableKeys,\n    onChange: props.onChange ? function (keys) {\n      var _props$onChange;\n\n      props === null || props === void 0 ? void 0 : (_props$onChange = props.onChange) === null || _props$onChange === void 0 ? void 0 : _props$onChange.call(props, // 计算编辑的key\n      keys, // 计算编辑的行\n      keys.map(function (key) {\n        return getRecordByKey(key);\n      }));\n    } : undefined\n  }),\n      _useMergedState2 = _slicedToArray(_useMergedState, 2),\n      editableKeys = _useMergedState2[0],\n      setEditableRowKeys = _useMergedState2[1];\n  /** 一个用来标志的set 提供了方便的 api 来去重什么的 */\n\n\n  var editableKeysSet = useMemo(function () {\n    var keys = editableType === 'single' ? editableKeys === null || editableKeys === void 0 ? void 0 : editableKeys.slice(0, 1) : editableKeys;\n    return new Set(keys);\n  }, [(editableKeys || []).join(','), editableType]);\n  var editableKeysRef = usePrevious(editableKeys);\n  /** 这行是不是编辑状态 */\n\n  var isEditable = useRefFunction(function (row) {\n    var _props$getRowKey, _props$getRowKey$toSt, _props$getRowKey2, _props$getRowKey2$toS; // 为了兼容一下name 模式的 indexKey，所以需要判断两次，一次是index，一次是没有 index 的\n\n\n    var recordKeyOrIndex = (_props$getRowKey = props.getRowKey(row, row.index)) === null || _props$getRowKey === void 0 ? void 0 : (_props$getRowKey$toSt = _props$getRowKey.toString) === null || _props$getRowKey$toSt === void 0 ? void 0 : _props$getRowKey$toSt.call(_props$getRowKey); // 这里是不设置 index 的地方\n\n    var recordKey = (_props$getRowKey2 = props.getRowKey(row, -1)) === null || _props$getRowKey2 === void 0 ? void 0 : (_props$getRowKey2$toS = _props$getRowKey2.toString) === null || _props$getRowKey2$toS === void 0 ? void 0 : _props$getRowKey2$toS.call(_props$getRowKey2); // 都转化为了字符串，不然 number 和 string\n\n    var stringEditableKeys = editableKeys.map(function (key) {\n      return key.toString();\n    });\n    var stringEditableKeysRef = (editableKeysRef === null || editableKeysRef === void 0 ? void 0 : editableKeysRef.map(function (key) {\n      return key.toString();\n    })) || [];\n    var preIsEditable = props.tableName && !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKey)) || !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKeyOrIndex));\n    return {\n      recordKey: recordKey,\n      isEditable: props.tableName && (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKey)) || (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKeyOrIndex)),\n      preIsEditable: preIsEditable\n    };\n  });\n  /**\n   * 进入编辑状态\n   *\n   * @param recordKey\n   */\n\n  var startEditable = useRefFunction(function (recordKey) {\n    // 如果是单行的话，不允许多行编辑\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    }\n\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  });\n  /**\n   * 退出编辑状态\n   *\n   * @param recordKey\n   */\n\n  var cancelEditable = useRefFunction(function (recordKey, needReTry) {\n    var relayKey = recordKeyToString(recordKey).toString();\n    var key = dataSourceKeyIndexMapRef.current.get(relayKey);\n    /** 如果没找到key，转化一下再去找 */\n\n    if (!editableKeysSet.has(relayKey) && key && (needReTry !== null && needReTry !== void 0 ? needReTry : true) && props.tableName) {\n      cancelEditable(key, false);\n      return;\n    }\n    /** 如果这个是 new Line 直接删除 */\n\n\n    if (newLineRecordCache && newLineRecordCache.options.recordKey === recordKey) {\n      setNewLineRecordCache(undefined);\n    }\n\n    editableKeysSet.delete(relayKey);\n    editableKeysSet.delete(recordKeyToString(recordKey));\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  });\n  var propsOnValuesChange = useDebounceFn( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n    var _props$onValuesChange;\n\n    var _len,\n        rest,\n        _key,\n        _args4 = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            for (_len = _args4.length, rest = new Array(_len), _key = 0; _key < _len; _key++) {\n              rest[_key] = _args4[_key];\n            } //@ts-ignore\n\n\n            (_props$onValuesChange = props.onValuesChange) === null || _props$onValuesChange === void 0 ? void 0 : _props$onValuesChange.call.apply(_props$onValuesChange, [props].concat(rest));\n\n          case 2:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  })), 64);\n  var onValuesChange = useRefFunction(function (value, values) {\n    var _Object$keys$pop;\n\n    if (!props.onValuesChange) {\n      return;\n    }\n\n    var dataSource = props.dataSource; // 这里是把正在编辑中的所有表单数据都修改掉\n    // 不然会用 props 里面的 dataSource，数据只有正在编辑中的\n    // Object.keys(get(values, [props.tableName || ''].flat(1)) || values).forEach((recordKey) => {\n\n    editableKeys.forEach(function (eachRecordKey) {\n      if ((newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.options.recordKey) === eachRecordKey) return;\n      var recordKey = eachRecordKey.toString(); // 如果数据在这个 form 中没有展示，也不显示\n\n      var editRow = get(values, [props.tableName || '', recordKey].flat(1).filter(function (key) {\n        return key || key === 0;\n      }));\n      if (!editRow) return;\n      dataSource = editableRowByKey({\n        data: dataSource,\n        getRowKey: props.getRowKey,\n        row: editRow,\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      }, 'update');\n    });\n    var relayValue = props.tableName ? get(value, [props.tableName || ''].flat(1)) : value;\n    var recordKey = (_Object$keys$pop = Object.keys(relayValue || {}).pop()) === null || _Object$keys$pop === void 0 ? void 0 : _Object$keys$pop.toString(); //从form 和 cache 中取得数据\n\n    var newLineRecordData = _objectSpread(_objectSpread({}, newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.defaultValue), get(values, [props.tableName || '', recordKey.toString()].flat(1).filter(function (key) {\n      return key || key === 0;\n    })));\n    /** 如果已经在 dataSource 中存在了，直接 find */\n\n\n    var editRow = dataSourceKeyIndexMapRef.current.has(recordKeyToString(recordKey)) ? dataSource.find(function (item, index) {\n      var _props$getRowKey3;\n\n      var key = (_props$getRowKey3 = props.getRowKey(item, index)) === null || _props$getRowKey3 === void 0 ? void 0 : _props$getRowKey3.toString();\n      return key === recordKey;\n    }) : newLineRecordData;\n    propsOnValuesChange.run(editRow || newLineRecordData, dataSource);\n  });\n  /**\n   * 同时只能支持一行,取消之后数据消息，不会触发 dataSource\n   *\n   * @param row\n   * @param options\n   * @name 增加新的行\n   */\n\n  var addEditRecord = useRefFunction(function (row, options) {\n    // 暂时不支持多行新增\n    if (newLineRecordRef.current) {\n      _message.warn(props.onlyAddOneLineAlertMessage || '只能新增一行');\n\n      return false;\n    } // 如果是单行的话，不允许多行编辑\n\n\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    } // 防止多次渲染\n\n\n    var recordKey = props.getRowKey(row, props.dataSource.length);\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet)); // 如果是dataSource 新增模式的话，取消再开始编辑，\n    // 这样就可以把新增到 dataSource的数据进入编辑模式了\n    // [a,b,cache] => [a,b,c]\n\n    if ((options === null || options === void 0 ? void 0 : options.newRecordType) === 'dataSource' || props.tableName) {\n      var _recordKeyToString3;\n\n      var actionProps = {\n        data: props.dataSource,\n        getRowKey: props.getRowKey,\n        row: _objectSpread(_objectSpread({}, row), {}, {\n          map_row_parentKey: (options === null || options === void 0 ? void 0 : options.parentKey) ? (_recordKeyToString3 = recordKeyToString(options === null || options === void 0 ? void 0 : options.parentKey)) === null || _recordKeyToString3 === void 0 ? void 0 : _recordKeyToString3.toString() : undefined\n        }),\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      };\n      props.setDataSource(editableRowByKey(actionProps, (options === null || options === void 0 ? void 0 : options.position) === 'top' ? 'top' : 'update'));\n    } else {\n      setNewLineRecordCache({\n        defaultValue: row,\n        options: _objectSpread(_objectSpread({}, options), {}, {\n          recordKey: recordKey\n        })\n      });\n    }\n\n    return true;\n  }); // Internationalization\n\n  var intl = useIntl();\n  var saveText = (props === null || props === void 0 ? void 0 : props.saveText) || intl.getMessage('editableTable.action.save', '保存');\n  var deleteText = (props === null || props === void 0 ? void 0 : props.deleteText) || intl.getMessage('editableTable.action.delete', '删除');\n  var cancelText = (props === null || props === void 0 ? void 0 : props.cancelText) || intl.getMessage('editableTable.action.cancel', '取消');\n  var actionSaveRef = useRefFunction( /*#__PURE__*/function () {\n    var _ref7 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(recordKey, editRow, originRow, newLine) {\n      var _props$onSave;\n\n      var _ref8, options, res, actionProps;\n\n      return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              _ref8 = newLine || {}, options = _ref8.options;\n              _context5.next = 3;\n              return props === null || props === void 0 ? void 0 : (_props$onSave = props.onSave) === null || _props$onSave === void 0 ? void 0 : _props$onSave.call(props, recordKey, editRow, originRow, newLine);\n\n            case 3:\n              res = _context5.sent; // 保存时解除编辑模式\n\n              cancelEditable(recordKey);\n\n              if (!(newLine && (options === null || options === void 0 ? void 0 : options.recordKey) === recordKey)) {\n                _context5.next = 8;\n                break;\n              }\n\n              if ((options === null || options === void 0 ? void 0 : options.position) === 'top') {\n                props.setDataSource([editRow].concat(_toConsumableArray(props.dataSource)));\n              } else {\n                props.setDataSource([].concat(_toConsumableArray(props.dataSource), [editRow]));\n              }\n\n              return _context5.abrupt(\"return\", res);\n\n            case 8:\n              actionProps = {\n                data: props.dataSource,\n                getRowKey: props.getRowKey,\n                row: editRow,\n                key: recordKey,\n                childrenColumnName: props.childrenColumnName || 'children'\n              };\n              props.setDataSource(editableRowByKey(actionProps, 'update'));\n              return _context5.abrupt(\"return\", res);\n\n            case 11:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5);\n    }));\n\n    return function (_x3, _x4, _x5, _x6) {\n      return _ref7.apply(this, arguments);\n    };\n  }());\n  var actionDeleteRef = useRefFunction( /*#__PURE__*/function () {\n    var _ref9 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(recordKey, editRow) {\n      var _props$onDelete;\n\n      var actionProps, res;\n      return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              actionProps = {\n                data: props.dataSource,\n                getRowKey: props.getRowKey,\n                row: editRow,\n                key: recordKey,\n                childrenColumnName: props.childrenColumnName || 'children'\n              };\n              _context6.next = 3;\n              return props === null || props === void 0 ? void 0 : (_props$onDelete = props.onDelete) === null || _props$onDelete === void 0 ? void 0 : _props$onDelete.call(props, recordKey, editRow);\n\n            case 3:\n              res = _context6.sent;\n              props.setDataSource(editableRowByKey(actionProps, 'delete'));\n              return _context6.abrupt(\"return\", res);\n\n            case 6:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, _callee6);\n    }));\n\n    return function (_x7, _x8) {\n      return _ref9.apply(this, arguments);\n    };\n  }());\n  var actionCancelRef = useRefFunction( /*#__PURE__*/function () {\n    var _ref10 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(recordKey, editRow, originRow, newLine) {\n      var _props$onCancel;\n\n      var res;\n      return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n        while (1) {\n          switch (_context7.prev = _context7.next) {\n            case 0:\n              _context7.next = 2;\n              return props === null || props === void 0 ? void 0 : (_props$onCancel = props.onCancel) === null || _props$onCancel === void 0 ? void 0 : _props$onCancel.call(props, recordKey, editRow, originRow, newLine);\n\n            case 2:\n              res = _context7.sent;\n              return _context7.abrupt(\"return\", res);\n\n            case 4:\n            case \"end\":\n              return _context7.stop();\n          }\n        }\n      }, _callee7);\n    }));\n\n    return function (_x9, _x10, _x11, _x12) {\n      return _ref10.apply(this, arguments);\n    };\n  }());\n\n  var actionRender = function actionRender(row, form) {\n    var key = props.getRowKey(row, row.index);\n    var config = {\n      saveText: saveText,\n      cancelText: cancelText,\n      deleteText: deleteText,\n      addEditRecord: addEditRecord,\n      recordKey: key,\n      cancelEditable: cancelEditable,\n      index: row.index,\n      tableName: props.tableName,\n      newLineConfig: newLineRecordCache,\n      onCancel: actionCancelRef,\n      onDelete: actionDeleteRef,\n      onSave: actionSaveRef,\n      form: form,\n      editableKeys: editableKeys,\n      setEditableRowKeys: setEditableRowKeys,\n      deletePopconfirmMessage: props.deletePopconfirmMessage || '删除此行？'\n    };\n    var defaultDoms = defaultActionRender(row, config);\n    if (props.actionRender) return props.actionRender(row, config, {\n      save: defaultDoms[0],\n      delete: defaultDoms[1],\n      cancel: defaultDoms[2]\n    });\n    return defaultDoms;\n  };\n\n  return {\n    editableKeys: editableKeys,\n    setEditableRowKeys: setEditableRowKeys,\n    isEditable: isEditable,\n    actionRender: actionRender,\n    startEditable: startEditable,\n    cancelEditable: cancelEditable,\n    addEditRecord: addEditRecord,\n    newLineRecord: newLineRecordCache,\n    preEditableKeys: editableKeysRef,\n    onValuesChange: onValuesChange\n  };\n}\n\nexport default useEditableArray;","map":{"version":3,"sources":["/home/kzj/project/finalize/final/code/react_code/node_modules/@ant-design/pro-card/node_modules/@ant-design/pro-utils/es/useEditableArray/index.js"],"names":["_message","_extends","_Popconfirm","_regeneratorRuntime","_toArray","_asyncToGenerator","_slicedToArray","_defineProperty","_toConsumableArray","_objectWithoutProperties","_objectSpread","_typeof","_excluded","_excluded2","React","useContext","useMemo","useRef","useState","useMergedState","useLazyKVMap","LoadingOutlined","useIntl","set","useMountMergeState","ProFormContext","merge","usePrevious","get","useDeepCompareEffectDebounce","useDebounceFn","useRefFunction","recordKeyToString","rowKey","Array","isArray","join","editableRowByKey","params","action","_recordKeyToString","getRowKey","row","data","childrenColumnName","key","toString","kvMap","Map","dig","records","map_row_parentKey","map_row_index","forEach","record","index","eachIndex","recordKey","newRecord","map_row_key","children","undefined","delete","fill","map","kvArrayMap","kvSource","value","reset","has","concat","rest","item","push","source","SaveEditableAction","_ref","onSave","form","newLineConfig","editorType","tableName","context","_useMountMergeState","_useMountMergeState2","loading","setLoading","createElement","onClick","_ref2","mark","_callee","e","_context$getFieldForm","isMapEditor","namePath","fields","_recordKey","recordKeyPath","curValue","res","wrap","_callee$","_context","prev","next","stopPropagation","preventDefault","flat","filter","Boolean","validateFields","recursive","getFieldFormatValue","call","getFieldValue","length","slice","sent","abrupt","t0","console","log","stop","_x","apply","arguments","style","marginRight","DeleteEditableAction","_ref3","onDelete","deletePopconfirmMessage","cancelEditable","_useMountMergeState3","_useMountMergeState4","onConfirm","_ref4","_callee2","_callee2$","_context2","setTimeout","title","CancelEditableAction","props","onCancel","cancelText","_ref5","_callee3","_context$getFieldForm2","_callee3$","_context3","setFieldsValue","_x2","defaultActionRender","config","saveText","deleteText","options","useEditableArray","_useState","_useState2","newLineRecordCache","setNewLineRecordCache","dataSourceKeyIndexMapRef","newLineRecordRef","_props$dataSource","dataSource","_recordKeyToString2","current","editableType","type","_useLazyKVMap","_useLazyKVMap2","getRecordByKey","_useMergedState","editableKeys","onChange","keys","_props$onChange","_useMergedState2","setEditableRowKeys","editableKeysSet","Set","editableKeysRef","isEditable","_props$getRowKey","_props$getRowKey$toSt","_props$getRowKey2","_props$getRowKey2$toS","recordKeyOrIndex","stringEditableKeys","stringEditableKeysRef","preIsEditable","includes","startEditable","size","warn","onlyOneLineEditorAlertMessage","add","from","needReTry","relayKey","propsOnValuesChange","_callee4","_props$onValuesChange","_len","_key","_args4","_callee4$","_context4","onValuesChange","values","_Object$keys$pop","eachRecordKey","editRow","relayValue","Object","pop","newLineRecordData","defaultValue","find","_props$getRowKey3","run","addEditRecord","onlyAddOneLineAlertMessage","newRecordType","_recordKeyToString3","actionProps","parentKey","setDataSource","position","intl","getMessage","actionSaveRef","_ref7","_callee5","originRow","newLine","_props$onSave","_ref8","_callee5$","_context5","_x3","_x4","_x5","_x6","actionDeleteRef","_ref9","_callee6","_props$onDelete","_callee6$","_context6","_x7","_x8","actionCancelRef","_ref10","_callee7","_props$onCancel","_callee7$","_context7","_x9","_x10","_x11","_x12","actionRender","defaultDoms","save","cancel","newLineRecord","preEditableKeys"],"mappings":"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","sourcesContent":["import \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport \"antd/es/popconfirm/style\";\nimport _Popconfirm from \"antd/es/popconfirm\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _toArray from \"@babel/runtime/helpers/esm/toArray\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport _typeof from \"@babel/runtime/helpers/esm/typeof\";\nvar _excluded = [\"map_row_parentKey\", \"map_row_key\"],\n    _excluded2 = [\"map_row_key\"];\n\n/* eslint-disable react-hooks/exhaustive-deps */\nimport React, { useContext, useMemo, useRef, useState } from 'react';\nimport useMergedState from \"rc-util/es/hooks/useMergedState\";\nimport useLazyKVMap from \"antd/es/table/hooks/useLazyKVMap\";\nimport { LoadingOutlined } from '@ant-design/icons';\nimport { useIntl } from '@ant-design/pro-provider';\nimport set from \"rc-util/es/utils/set\";\nimport useMountMergeState from '../useMountMergeState';\nimport ProFormContext from '../components/ProFormContext';\nimport { merge } from '../merge';\nimport usePrevious from '../hooks/usePrevious';\nimport get from \"rc-util/es/utils/get\";\nimport { useDeepCompareEffectDebounce } from '../hooks/useDeepCompareEffect';\nimport { useDebounceFn, useRefFunction } from '..';\nexport var recordKeyToString = function recordKeyToString(rowKey) {\n  if (Array.isArray(rowKey)) return rowKey.join(',');\n  return rowKey;\n};\n/**\n * 使用map 来删除数据，性能一般 但是准确率比较高\n *\n * @param params\n * @param action\n */\n\nexport function editableRowByKey(params, action) {\n  var _recordKeyToString;\n\n  var getRowKey = params.getRowKey,\n      row = params.row,\n      data = params.data,\n      childrenColumnName = params.childrenColumnName;\n  var key = (_recordKeyToString = recordKeyToString(params.key)) === null || _recordKeyToString === void 0 ? void 0 : _recordKeyToString.toString();\n  var kvMap = new Map();\n  /**\n   * 打平这个数组\n   *\n   * @param records\n   * @param parentKey\n   */\n\n  function dig(records, map_row_parentKey, map_row_index) {\n    records.forEach(function (record, index) {\n      var eachIndex = (map_row_index || 0) * 10 + index;\n      var recordKey = getRowKey(record, eachIndex).toString(); // children 取在前面方便拼的时候按照反顺序放回去\n\n      if (record && _typeof(record) === 'object' && childrenColumnName in record) {\n        dig(record[childrenColumnName] || [], recordKey, eachIndex);\n      }\n\n      var newRecord = _objectSpread(_objectSpread({}, record), {}, {\n        map_row_key: recordKey,\n        children: undefined,\n        map_row_parentKey: map_row_parentKey\n      });\n\n      delete newRecord.children;\n\n      if (!map_row_parentKey) {\n        delete newRecord.map_row_parentKey;\n      }\n\n      kvMap.set(recordKey, newRecord);\n    });\n  }\n\n  if (action === 'top') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  dig(data);\n\n  if (action === 'update') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  if (action === 'delete') {\n    kvMap.delete(key);\n  }\n\n  var fill = function fill(map) {\n    var kvArrayMap = new Map();\n    var kvSource = [];\n    map.forEach(function (value) {\n      if (value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_parentKey = value.map_row_parentKey,\n            map_row_key = value.map_row_key,\n            reset = _objectWithoutProperties(value, _excluded);\n\n        if (kvArrayMap.has(map_row_key)) {\n          reset[childrenColumnName] = kvArrayMap.get(map_row_key);\n        }\n\n        kvArrayMap.set(map_row_parentKey, [].concat(_toConsumableArray(kvArrayMap.get(map_row_parentKey) || []), [reset]));\n      }\n    });\n    map.forEach(function (value) {\n      if (!value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_key = value.map_row_key,\n            rest = _objectWithoutProperties(value, _excluded2);\n\n        if (kvArrayMap.has(map_row_key)) {\n          var item = _objectSpread(_objectSpread({}, rest), {}, _defineProperty({}, childrenColumnName, kvArrayMap.get(map_row_key)));\n\n          kvSource.push(item);\n          return;\n        }\n\n        kvSource.push(rest);\n      }\n    });\n    return kvSource;\n  };\n\n  var source = fill(kvMap);\n  return source;\n}\n/**\n * 保存按钮的dom\n *\n * @param ActionRenderConfig\n */\n\nexport function SaveEditableAction(_ref) {\n  var recordKey = _ref.recordKey,\n      onSave = _ref.onSave,\n      form = _ref.form,\n      row = _ref.row,\n      children = _ref.children,\n      newLineConfig = _ref.newLineConfig,\n      editorType = _ref.editorType,\n      tableName = _ref.tableName;\n  var context = useContext(ProFormContext);\n\n  var _useMountMergeState = useMountMergeState(false),\n      _useMountMergeState2 = _slicedToArray(_useMountMergeState, 2),\n      loading = _useMountMergeState2[0],\n      setLoading = _useMountMergeState2[1];\n\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"save\",\n    onClick: /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(e) {\n        var _context$getFieldForm, isMapEditor, namePath, fields, _recordKey, recordKeyPath, curValue, data, res;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                _context.prev = 2;\n                isMapEditor = editorType === 'Map'; // 为了兼容类型为 array 的 dataIndex,当 recordKey 是一个数组时，用于获取表单值的 key 只取第一项，\n                // 从表单中获取回来之后，再根据 namepath 获取具体的某个字段并设置\n\n                namePath = [tableName, Array.isArray(recordKey) ? recordKey[0] : recordKey].map(function (key) {\n                  return key === null || key === void 0 ? void 0 : key.toString();\n                }).flat(1).filter(Boolean);\n                setLoading(true); // @ts-expect-error\n\n                _context.next = 8;\n                return form.validateFields(namePath, {\n                  recursive: true\n                });\n\n              case 8:\n                fields = ((_context$getFieldForm = context.getFieldFormatValue) === null || _context$getFieldForm === void 0 ? void 0 : _context$getFieldForm.call(context, namePath)) || form.getFieldValue(namePath); // 处理 dataIndex 为数组的情况\n\n                if (Array.isArray(recordKey) && recordKey.length > 1) {\n                  // 获取 namepath\n                  _recordKey = _toArray(recordKey), recordKeyPath = _recordKey.slice(1); // 将目标值获取出来并设置到 fields 当中\n\n                  curValue = get(fields, recordKeyPath);\n                  set(fields, recordKeyPath, curValue);\n                }\n\n                data = isMapEditor ? set({}, namePath, fields, true) : fields; // 获取数据并保存\n\n                _context.next = 13;\n                return onSave === null || onSave === void 0 ? void 0 : onSave(recordKey, // 如果是 map 模式，fields 就是一个值，所以需要set 到对象中\n                // 数据模式 fields 是一个对象，所以不需要\n                merge({}, row, data), row, newLineConfig);\n\n              case 13:\n                res = _context.sent;\n                setLoading(false);\n                return _context.abrupt(\"return\", res);\n\n              case 18:\n                _context.prev = 18;\n                _context.t0 = _context[\"catch\"](2);\n                // eslint-disable-next-line no-console\n                console.log(_context.t0);\n                setLoading(false);\n                return _context.abrupt(\"return\", null);\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[2, 18]]);\n      }));\n\n      return function (_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }()\n  }, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '保存');\n}\n/**\n * 删除按钮 dom\n *\n * @param ActionRenderConfig\n */\n\nexport var DeleteEditableAction = function DeleteEditableAction(_ref3) {\n  var recordKey = _ref3.recordKey,\n      onDelete = _ref3.onDelete,\n      row = _ref3.row,\n      children = _ref3.children,\n      deletePopconfirmMessage = _ref3.deletePopconfirmMessage,\n      cancelEditable = _ref3.cancelEditable;\n\n  var _useMountMergeState3 = useMountMergeState(function () {\n    return false;\n  }),\n      _useMountMergeState4 = _slicedToArray(_useMountMergeState3, 2),\n      loading = _useMountMergeState4[0],\n      setLoading = _useMountMergeState4[1];\n\n  var onConfirm = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var res;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              setLoading(true);\n              _context2.next = 4;\n              return onDelete === null || onDelete === void 0 ? void 0 : onDelete(recordKey, row);\n\n            case 4:\n              res = _context2.sent;\n              setLoading(false);\n              setTimeout(function () {\n                cancelEditable(recordKey);\n              }, 0);\n              return _context2.abrupt(\"return\", res);\n\n            case 10:\n              _context2.prev = 10;\n              _context2.t0 = _context2[\"catch\"](0);\n              // eslint-disable-next-line no-console\n              console.log(_context2.t0);\n              setLoading(false);\n              return _context2.abrupt(\"return\", null);\n\n            case 15:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 10]]);\n    }));\n\n    return function onConfirm() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  return children !== false ? /*#__PURE__*/React.createElement(_Popconfirm, {\n    key: \"delete\",\n    title: deletePopconfirmMessage,\n    onConfirm: onConfirm\n  }, /*#__PURE__*/React.createElement(\"a\", null, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '删除')) : null;\n};\n\nvar CancelEditableAction = function CancelEditableAction(props) {\n  var recordKey = props.recordKey,\n      tableName = props.tableName,\n      newLineConfig = props.newLineConfig,\n      form = props.form,\n      editorType = props.editorType,\n      onCancel = props.onCancel,\n      cancelEditable = props.cancelEditable,\n      row = props.row,\n      cancelText = props.cancelText;\n  var context = useContext(ProFormContext);\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"cancel\",\n    onClick: /*#__PURE__*/function () {\n      var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(e) {\n        var _context$getFieldForm2;\n\n        var isMapEditor, namePath, fields, record, res;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                isMapEditor = editorType === 'Map';\n                namePath = [tableName, recordKey].flat(1).filter(Boolean);\n                fields = ((_context$getFieldForm2 = context.getFieldFormatValue) === null || _context$getFieldForm2 === void 0 ? void 0 : _context$getFieldForm2.call(context, namePath)) || form.getFieldValue(namePath);\n                record = isMapEditor ? set({}, namePath, fields) : fields;\n                _context3.next = 8;\n                return onCancel === null || onCancel === void 0 ? void 0 : onCancel(recordKey, record, row, newLineConfig);\n\n              case 8:\n                res = _context3.sent;\n                cancelEditable(recordKey);\n                /** 充值为默认值，不然编辑的行会丢掉 */\n\n                form.setFieldsValue(_defineProperty({}, recordKey, isMapEditor ? get(row, namePath) : row));\n                return _context3.abrupt(\"return\", res);\n\n              case 12:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function (_x2) {\n        return _ref5.apply(this, arguments);\n      };\n    }()\n  }, cancelText || '取消');\n};\n\nexport function defaultActionRender(row, config) {\n  var recordKey = config.recordKey,\n      newLineConfig = config.newLineConfig,\n      saveText = config.saveText,\n      deleteText = config.deleteText;\n  return [/*#__PURE__*/React.createElement(SaveEditableAction, _extends({\n    key: \"save\"\n  }, config, {\n    row: row\n  }), saveText), (newLineConfig === null || newLineConfig === void 0 ? void 0 : newLineConfig.options.recordKey) !== recordKey ? /*#__PURE__*/React.createElement(DeleteEditableAction, _extends({\n    key: \"delete\"\n  }, config, {\n    row: row\n  }), deleteText) : null, /*#__PURE__*/React.createElement(CancelEditableAction, _extends({\n    key: \"cancel\"\n  }, config, {\n    row: row\n  }))];\n}\n/**\n * 一个方便的hooks 用于维护编辑的状态\n *\n * @param props\n */\n\nfunction useEditableArray(props) {\n  var _useState = useState(undefined),\n      _useState2 = _slicedToArray(_useState, 2),\n      newLineRecordCache = _useState2[0],\n      setNewLineRecordCache = _useState2[1];\n\n  var dataSourceKeyIndexMapRef = useRef(new Map());\n  var newLineRecordRef = useRef(undefined);\n  useDeepCompareEffectDebounce(function () {\n    var _props$dataSource;\n\n    var map = new Map();\n    (_props$dataSource = props.dataSource) === null || _props$dataSource === void 0 ? void 0 : _props$dataSource.forEach(function (record, index) {\n      var _recordKeyToString2;\n\n      map.set(index.toString(), recordKeyToString(props.getRowKey(record, -1)));\n      map.set((_recordKeyToString2 = recordKeyToString(props.getRowKey(record, -1))) === null || _recordKeyToString2 === void 0 ? void 0 : _recordKeyToString2.toString(), index.toString());\n    });\n    dataSourceKeyIndexMapRef.current = map;\n  }, [props.dataSource]); // 这里这么做是为了存上次的状态，不然每次存一下再拿\n\n  newLineRecordRef.current = newLineRecordCache;\n  var editableType = props.type || 'single';\n\n  var _useLazyKVMap = useLazyKVMap(props.dataSource, 'children', props.getRowKey),\n      _useLazyKVMap2 = _slicedToArray(_useLazyKVMap, 1),\n      getRecordByKey = _useLazyKVMap2[0];\n\n  var _useMergedState = useMergedState([], {\n    value: props.editableKeys,\n    onChange: props.onChange ? function (keys) {\n      var _props$onChange;\n\n      props === null || props === void 0 ? void 0 : (_props$onChange = props.onChange) === null || _props$onChange === void 0 ? void 0 : _props$onChange.call(props, // 计算编辑的key\n      keys, // 计算编辑的行\n      keys.map(function (key) {\n        return getRecordByKey(key);\n      }));\n    } : undefined\n  }),\n      _useMergedState2 = _slicedToArray(_useMergedState, 2),\n      editableKeys = _useMergedState2[0],\n      setEditableRowKeys = _useMergedState2[1];\n  /** 一个用来标志的set 提供了方便的 api 来去重什么的 */\n\n\n  var editableKeysSet = useMemo(function () {\n    var keys = editableType === 'single' ? editableKeys === null || editableKeys === void 0 ? void 0 : editableKeys.slice(0, 1) : editableKeys;\n    return new Set(keys);\n  }, [(editableKeys || []).join(','), editableType]);\n  var editableKeysRef = usePrevious(editableKeys);\n  /** 这行是不是编辑状态 */\n\n  var isEditable = useRefFunction(function (row) {\n    var _props$getRowKey, _props$getRowKey$toSt, _props$getRowKey2, _props$getRowKey2$toS;\n\n    // 为了兼容一下name 模式的 indexKey，所以需要判断两次，一次是index，一次是没有 index 的\n    var recordKeyOrIndex = (_props$getRowKey = props.getRowKey(row, row.index)) === null || _props$getRowKey === void 0 ? void 0 : (_props$getRowKey$toSt = _props$getRowKey.toString) === null || _props$getRowKey$toSt === void 0 ? void 0 : _props$getRowKey$toSt.call(_props$getRowKey); // 这里是不设置 index 的地方\n\n    var recordKey = (_props$getRowKey2 = props.getRowKey(row, -1)) === null || _props$getRowKey2 === void 0 ? void 0 : (_props$getRowKey2$toS = _props$getRowKey2.toString) === null || _props$getRowKey2$toS === void 0 ? void 0 : _props$getRowKey2$toS.call(_props$getRowKey2); // 都转化为了字符串，不然 number 和 string\n\n    var stringEditableKeys = editableKeys.map(function (key) {\n      return key.toString();\n    });\n    var stringEditableKeysRef = (editableKeysRef === null || editableKeysRef === void 0 ? void 0 : editableKeysRef.map(function (key) {\n      return key.toString();\n    })) || [];\n    var preIsEditable = props.tableName && !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKey)) || !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKeyOrIndex));\n    return {\n      recordKey: recordKey,\n      isEditable: props.tableName && (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKey)) || (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKeyOrIndex)),\n      preIsEditable: preIsEditable\n    };\n  });\n  /**\n   * 进入编辑状态\n   *\n   * @param recordKey\n   */\n\n  var startEditable = useRefFunction(function (recordKey) {\n    // 如果是单行的话，不允许多行编辑\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    }\n\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  });\n  /**\n   * 退出编辑状态\n   *\n   * @param recordKey\n   */\n\n  var cancelEditable = useRefFunction(function (recordKey, needReTry) {\n    var relayKey = recordKeyToString(recordKey).toString();\n    var key = dataSourceKeyIndexMapRef.current.get(relayKey);\n    /** 如果没找到key，转化一下再去找 */\n\n    if (!editableKeysSet.has(relayKey) && key && (needReTry !== null && needReTry !== void 0 ? needReTry : true) && props.tableName) {\n      cancelEditable(key, false);\n      return;\n    }\n    /** 如果这个是 new Line 直接删除 */\n\n\n    if (newLineRecordCache && newLineRecordCache.options.recordKey === recordKey) {\n      setNewLineRecordCache(undefined);\n    }\n\n    editableKeysSet.delete(relayKey);\n    editableKeysSet.delete(recordKeyToString(recordKey));\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  });\n  var propsOnValuesChange = useDebounceFn( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n    var _props$onValuesChange;\n\n    var _len,\n        rest,\n        _key,\n        _args4 = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            for (_len = _args4.length, rest = new Array(_len), _key = 0; _key < _len; _key++) {\n              rest[_key] = _args4[_key];\n            }\n\n            //@ts-ignore\n            (_props$onValuesChange = props.onValuesChange) === null || _props$onValuesChange === void 0 ? void 0 : _props$onValuesChange.call.apply(_props$onValuesChange, [props].concat(rest));\n\n          case 2:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  })), 64);\n  var onValuesChange = useRefFunction(function (value, values) {\n    var _Object$keys$pop;\n\n    if (!props.onValuesChange) {\n      return;\n    }\n\n    var dataSource = props.dataSource; // 这里是把正在编辑中的所有表单数据都修改掉\n    // 不然会用 props 里面的 dataSource，数据只有正在编辑中的\n    // Object.keys(get(values, [props.tableName || ''].flat(1)) || values).forEach((recordKey) => {\n\n    editableKeys.forEach(function (eachRecordKey) {\n      if ((newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.options.recordKey) === eachRecordKey) return;\n      var recordKey = eachRecordKey.toString(); // 如果数据在这个 form 中没有展示，也不显示\n\n      var editRow = get(values, [props.tableName || '', recordKey].flat(1).filter(function (key) {\n        return key || key === 0;\n      }));\n      if (!editRow) return;\n      dataSource = editableRowByKey({\n        data: dataSource,\n        getRowKey: props.getRowKey,\n        row: editRow,\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      }, 'update');\n    });\n    var relayValue = props.tableName ? get(value, [props.tableName || ''].flat(1)) : value;\n    var recordKey = (_Object$keys$pop = Object.keys(relayValue || {}).pop()) === null || _Object$keys$pop === void 0 ? void 0 : _Object$keys$pop.toString(); //从form 和 cache 中取得数据\n\n    var newLineRecordData = _objectSpread(_objectSpread({}, newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.defaultValue), get(values, [props.tableName || '', recordKey.toString()].flat(1).filter(function (key) {\n      return key || key === 0;\n    })));\n    /** 如果已经在 dataSource 中存在了，直接 find */\n\n\n    var editRow = dataSourceKeyIndexMapRef.current.has(recordKeyToString(recordKey)) ? dataSource.find(function (item, index) {\n      var _props$getRowKey3;\n\n      var key = (_props$getRowKey3 = props.getRowKey(item, index)) === null || _props$getRowKey3 === void 0 ? void 0 : _props$getRowKey3.toString();\n      return key === recordKey;\n    }) : newLineRecordData;\n    propsOnValuesChange.run(editRow || newLineRecordData, dataSource);\n  });\n  /**\n   * 同时只能支持一行,取消之后数据消息，不会触发 dataSource\n   *\n   * @param row\n   * @param options\n   * @name 增加新的行\n   */\n\n  var addEditRecord = useRefFunction(function (row, options) {\n    // 暂时不支持多行新增\n    if (newLineRecordRef.current) {\n      _message.warn(props.onlyAddOneLineAlertMessage || '只能新增一行');\n\n      return false;\n    } // 如果是单行的话，不允许多行编辑\n\n\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    } // 防止多次渲染\n\n\n    var recordKey = props.getRowKey(row, props.dataSource.length);\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet)); // 如果是dataSource 新增模式的话，取消再开始编辑，\n    // 这样就可以把新增到 dataSource的数据进入编辑模式了\n    // [a,b,cache] => [a,b,c]\n\n    if ((options === null || options === void 0 ? void 0 : options.newRecordType) === 'dataSource' || props.tableName) {\n      var _recordKeyToString3;\n\n      var actionProps = {\n        data: props.dataSource,\n        getRowKey: props.getRowKey,\n        row: _objectSpread(_objectSpread({}, row), {}, {\n          map_row_parentKey: (options === null || options === void 0 ? void 0 : options.parentKey) ? (_recordKeyToString3 = recordKeyToString(options === null || options === void 0 ? void 0 : options.parentKey)) === null || _recordKeyToString3 === void 0 ? void 0 : _recordKeyToString3.toString() : undefined\n        }),\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      };\n      props.setDataSource(editableRowByKey(actionProps, (options === null || options === void 0 ? void 0 : options.position) === 'top' ? 'top' : 'update'));\n    } else {\n      setNewLineRecordCache({\n        defaultValue: row,\n        options: _objectSpread(_objectSpread({}, options), {}, {\n          recordKey: recordKey\n        })\n      });\n    }\n\n    return true;\n  }); // Internationalization\n\n  var intl = useIntl();\n  var saveText = (props === null || props === void 0 ? void 0 : props.saveText) || intl.getMessage('editableTable.action.save', '保存');\n  var deleteText = (props === null || props === void 0 ? void 0 : props.deleteText) || intl.getMessage('editableTable.action.delete', '删除');\n  var cancelText = (props === null || props === void 0 ? void 0 : props.cancelText) || intl.getMessage('editableTable.action.cancel', '取消');\n  var actionSaveRef = useRefFunction( /*#__PURE__*/function () {\n    var _ref7 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(recordKey, editRow, originRow, newLine) {\n      var _props$onSave;\n\n      var _ref8, options, res, actionProps;\n\n      return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              _ref8 = newLine || {}, options = _ref8.options;\n              _context5.next = 3;\n              return props === null || props === void 0 ? void 0 : (_props$onSave = props.onSave) === null || _props$onSave === void 0 ? void 0 : _props$onSave.call(props, recordKey, editRow, originRow, newLine);\n\n            case 3:\n              res = _context5.sent;\n              // 保存时解除编辑模式\n              cancelEditable(recordKey);\n\n              if (!(newLine && (options === null || options === void 0 ? void 0 : options.recordKey) === recordKey)) {\n                _context5.next = 8;\n                break;\n              }\n\n              if ((options === null || options === void 0 ? void 0 : options.position) === 'top') {\n                props.setDataSource([editRow].concat(_toConsumableArray(props.dataSource)));\n              } else {\n                props.setDataSource([].concat(_toConsumableArray(props.dataSource), [editRow]));\n              }\n\n              return _context5.abrupt(\"return\", res);\n\n            case 8:\n              actionProps = {\n                data: props.dataSource,\n                getRowKey: props.getRowKey,\n                row: editRow,\n                key: recordKey,\n                childrenColumnName: props.childrenColumnName || 'children'\n              };\n              props.setDataSource(editableRowByKey(actionProps, 'update'));\n              return _context5.abrupt(\"return\", res);\n\n            case 11:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5);\n    }));\n\n    return function (_x3, _x4, _x5, _x6) {\n      return _ref7.apply(this, arguments);\n    };\n  }());\n  var actionDeleteRef = useRefFunction( /*#__PURE__*/function () {\n    var _ref9 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(recordKey, editRow) {\n      var _props$onDelete;\n\n      var actionProps, res;\n      return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              actionProps = {\n                data: props.dataSource,\n                getRowKey: props.getRowKey,\n                row: editRow,\n                key: recordKey,\n                childrenColumnName: props.childrenColumnName || 'children'\n              };\n              _context6.next = 3;\n              return props === null || props === void 0 ? void 0 : (_props$onDelete = props.onDelete) === null || _props$onDelete === void 0 ? void 0 : _props$onDelete.call(props, recordKey, editRow);\n\n            case 3:\n              res = _context6.sent;\n              props.setDataSource(editableRowByKey(actionProps, 'delete'));\n              return _context6.abrupt(\"return\", res);\n\n            case 6:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, _callee6);\n    }));\n\n    return function (_x7, _x8) {\n      return _ref9.apply(this, arguments);\n    };\n  }());\n  var actionCancelRef = useRefFunction( /*#__PURE__*/function () {\n    var _ref10 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(recordKey, editRow, originRow, newLine) {\n      var _props$onCancel;\n\n      var res;\n      return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n        while (1) {\n          switch (_context7.prev = _context7.next) {\n            case 0:\n              _context7.next = 2;\n              return props === null || props === void 0 ? void 0 : (_props$onCancel = props.onCancel) === null || _props$onCancel === void 0 ? void 0 : _props$onCancel.call(props, recordKey, editRow, originRow, newLine);\n\n            case 2:\n              res = _context7.sent;\n              return _context7.abrupt(\"return\", res);\n\n            case 4:\n            case \"end\":\n              return _context7.stop();\n          }\n        }\n      }, _callee7);\n    }));\n\n    return function (_x9, _x10, _x11, _x12) {\n      return _ref10.apply(this, arguments);\n    };\n  }());\n\n  var actionRender = function actionRender(row, form) {\n    var key = props.getRowKey(row, row.index);\n    var config = {\n      saveText: saveText,\n      cancelText: cancelText,\n      deleteText: deleteText,\n      addEditRecord: addEditRecord,\n      recordKey: key,\n      cancelEditable: cancelEditable,\n      index: row.index,\n      tableName: props.tableName,\n      newLineConfig: newLineRecordCache,\n      onCancel: actionCancelRef,\n      onDelete: actionDeleteRef,\n      onSave: actionSaveRef,\n      form: form,\n      editableKeys: editableKeys,\n      setEditableRowKeys: setEditableRowKeys,\n      deletePopconfirmMessage: props.deletePopconfirmMessage || '删除此行？'\n    };\n    var defaultDoms = defaultActionRender(row, config);\n    if (props.actionRender) return props.actionRender(row, config, {\n      save: defaultDoms[0],\n      delete: defaultDoms[1],\n      cancel: defaultDoms[2]\n    });\n    return defaultDoms;\n  };\n\n  return {\n    editableKeys: editableKeys,\n    setEditableRowKeys: setEditableRowKeys,\n    isEditable: isEditable,\n    actionRender: actionRender,\n    startEditable: startEditable,\n    cancelEditable: cancelEditable,\n    addEditRecord: addEditRecord,\n    newLineRecord: newLineRecordCache,\n    preEditableKeys: editableKeysRef,\n    onValuesChange: onValuesChange\n  };\n}\n\nexport default useEditableArray;"]},"metadata":{},"sourceType":"module"}