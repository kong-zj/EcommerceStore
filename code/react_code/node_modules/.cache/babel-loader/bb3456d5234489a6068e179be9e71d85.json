{"ast":null,"code":"import \"antd/es/drawer/style\";\nimport _Drawer from \"antd/es/drawer\";\nimport \"antd/es/input/style\";\nimport _Input from \"antd/es/input\";\nimport \"antd/es/input-number/style\";\nimport _InputNumber from \"antd/es/input-number\";\nimport \"antd/es/divider/style\";\nimport _Divider from \"antd/es/divider\";\nimport \"antd/es/space/style\";\nimport _Space from \"antd/es/space\";\nimport \"antd/es/button/style\";\nimport _Button from \"antd/es/button\";\nimport \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport \"antd/es/form/style\";\nimport _Form from \"antd/es/form\";\nimport \"antd/es/select/style\";\nimport _Select from \"antd/es/select\";\nvar _jsxFileName = \"/home/kzj/project/finalize/final/code/react_code/src/components/Bid/index.jsx\";\nimport React, { Component } from \"react\";\nimport { UserOutlined, LaptopOutlined, FileSearchOutlined, HomeOutlined, EyeTwoTone, EyeInvisibleOutlined } from '@ant-design/icons';\nimport cookie from \"react-cookies\"; //接入web3\n\nimport getWeb3 from \"../../utils/getWeb3\";\nimport getEcommerceStore from \"../../utils/getEcommerceStore\";\nimport saveAccountString from \"../../utils/saveAccountString\";\nimport openNotification from \"../Notification\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst {\n  Option\n} = _Select;\n\nconst suffixSelector = /*#__PURE__*/_jsxDEV(_Form.Item, {\n  name: \"PriceUnit\",\n  noStyle: true,\n  children: /*#__PURE__*/_jsxDEV(_Select, {\n    style: {\n      width: 70\n    },\n    children: [/*#__PURE__*/_jsxDEV(Option, {\n      selected: \"selected\",\n      value: \"ETH\",\n      children: \"ETH\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 21,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(Option, {\n      value: \"wei\",\n      children: \"wei\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 22,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 16,\n    columnNumber: 7\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 15,\n  columnNumber: 5\n}, this);\n\nclass Bid extends Component {\n  constructor(props) {\n    super(props); // this.changePage = this.changePage.bind(this);\n\n    this.state = {\n      username: cookie.load('username'),\n      //web3 与 truffleContract 不能作为参数传递到其他路由\n      //BUG\n      web3: null,\n      truffleContract: null\n    };\n\n    this.showDrawer = () => {\n      this.setState({\n        visible: true\n      });\n    };\n\n    this.onClose = () => {\n      this.setState({\n        visible: false\n      });\n    };\n\n    this.onFinishFailed = errorInfo => {\n      _message.warning(\"请正确填写商品ID信息\", 2);\n    };\n\n    this.onFinishBid = values => {\n      console.log(\"竞拍提交按钮被点击，onFinishBid 得到的数据为 : \");\n      console.dir(values); //values 中的数据示意\n      // BidAmount: 1\n      // BidSecret: \"33\"\n      // PriceUnit: \"ETH\"\n      // SendAmount: 2\n\n      if (this.state.dataArray.length === 0) {\n        _message.error(\"找不到正在竞拍的商品\");\n\n        return;\n      }\n\n      if (values.PriceUnit === undefined) {\n        _message.error(\"请指定价格单位\");\n\n        return;\n      } //判断是否符合竞拍规则\n\n\n      if (values.BidAmount > values.SendAmount) {\n        _message.error(\"押金低于竞拍价\", 2);\n\n        return;\n      } //把价格单位换算成wei进行比较，这里的换算写死了，后期改成 web3 中的换算方法\n\n\n      console.log(\"竞拍使用的价格单位 : \" + values.PriceUnit);\n      let bidPrice = values.PriceUnit === \"ETH\" ? values.BidAmount * 1e18 : values.BidAmount;\n      let sendPrice = values.PriceUnit === \"ETH\" ? values.SendAmount * 1e18 : values.SendAmount;\n      let startPrice = this.state.dataArray[0].originPrice; //startPrice 与 bidPrice 的单位都是 wei\n\n      console.log(\"起拍价 : \" + startPrice + \", 竞拍价 : \" + bidPrice);\n\n      if (bidPrice < startPrice) {\n        _message.error(\"竞拍价低于起拍价\", 2);\n\n        return;\n      }\n\n      let blockChainID = this.state.dataArray[0].ID;\n      console.log(\"竞拍商品ID : \" + blockChainID);\n      let web3 = this.state.web3; //注意这里的解析方式应和合约代码中的对应\n      // let sealedBid = web3.utils.keccak256(web3.utils.toWei(string(amount), 'ether'));\n      //这里传给toWei的第一个参数不要求是字符串类型的，与truffle中使用toWei不同\n\n      console.log(\"传给keccak256的参数是 \" + (\"\" + bidPrice) + values.BidSecret); //信息加密\n\n      let sealedBid = web3.utils.keccak256(\"\" + bidPrice + values.BidSecret).toString('hex');\n      console.log(\"用 keccak256 加密之后 sealedBid = \" + sealedBid); //竞价信息上链\n      //注意回调函数中的this，和外界的this不同，如果向使用外界的this，要赋值成that传过去\n      //注意要使用async，确保先拿到地址，用await关键字确保运行的先后顺序，再用这个地址调用合约方法\n\n      let that = this;\n      this.state.truffleContract.deployed().then(async i => {\n        console.log(\"进入 this.state.truffleContract.deployed() 的回调函数\"); //测试时要在MetaMask中选中ganache提供的10个地址之一，from自己创建的地址会失败\n        //即时获取当前地址，用该地址发交易\n\n        let currentAccount = await that.state.web3.eth.getAccounts();\n\n        _message.info(\"交易发起地址为: \" + currentAccount, 2);\n\n        console.log(\"交易发起地址为: \" + currentAccount);\n\n        try {\n          //调用合约的 bid 方法\n          await i.bid(parseInt(blockChainID), sealedBid, {\n            from: currentAccount.toString(),\n            value: sendPrice\n          }).then(res => {\n            //注意这里调用合约方法使用的地址，必须是字符串形式，要用 toString() 转化为字符串\n            _message.success(\"竞价提交成功\");\n\n            console.log(\"成功调用合约的bid方法，返回 : \");\n            console.dir(res); //关闭侧边栏\n\n            this.onClose();\n            openNotification(\"竞价提交成功\", \"您的报价: \" + values.BidAmount + values.PriceUnit + \", 您的押金: \" + values.SendAmount + values.PriceUnit + \", 距离揭示报价 \" + this.state.dataArray[0].processTime, 'bottomLeft');\n          });\n        } catch (err) {\n          _message.error(\"向链上提交竞价信息失败\", 2);\n\n          console.log(\"调用合约的bid方法失败 \" + err);\n          return;\n        }\n      });\n    };\n\n    this.onFinishFailedBid = errorInfo => {\n      _message.warning(\"请正确填写竞拍信息\", 2);\n    };\n  }\n\n  render() {\n    return /*#__PURE__*/_jsxDEV(_Drawer, {\n      title: \"\\u51FA\\u793A\\u60A8\\u7684\\u62A5\\u4EF7\",\n      width: 400,\n      onClose: this.onClose,\n      visible: this.state.visible,\n      bodyStyle: {\n        paddingBottom: 80\n      },\n      extra: /*#__PURE__*/_jsxDEV(_Space, {\n        children: /*#__PURE__*/_jsxDEV(_Button, {\n          onClick: this.onClose,\n          children: \"\\u53D6\\u6D88\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 166,\n          columnNumber: 15\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 165,\n        columnNumber: 13\n      }, this),\n      children: [/*#__PURE__*/_jsxDEV(\"p\", {\n        children: [\"\\u8D77\\u62CD\\u4EF7: \", /*#__PURE__*/_jsxDEV(\"b\", {\n          children: \"productData.price\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 170,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 170,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(_Divider, {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 171,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(_Form, {\n        layout: \"vertical\",\n        hideRequiredMark: true,\n        onFinish: this.onFinishBid,\n        onFinishFailed: this.onFinishFailedBid,\n        children: [/*#__PURE__*/_jsxDEV(_Form.Item, {\n          name: \"BidAmount\",\n          label: \"\\u7ADE\\u62CD\\u4EF7\\u683C\",\n          rules: [{\n            required: true,\n            message: '请输入竞拍价格'\n          }],\n          children: /*#__PURE__*/_jsxDEV(_InputNumber, {\n            min: 0,\n            placeholder: \"\\u7ADE\\u62CD\\u4EF7\\u683C\\u4E0D\\u4F4E\\u4E8E\\u8D77\\u62CD\\u4EF7\",\n            addonAfter: suffixSelector,\n            style: {\n              width: '100%'\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 188,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 178,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(_Form.Item, {\n          name: \"SendAmount\",\n          label: \"\\u7ADE\\u62CD\\u62BC\\u91D1\",\n          rules: [{\n            required: true,\n            message: '请输入竞拍押金'\n          }],\n          children: /*#__PURE__*/_jsxDEV(_InputNumber, {\n            min: 0,\n            placeholder: \"\\u7ADE\\u62CD\\u62BC\\u91D1\\u4E0D\\u4F4E\\u4E8E\\u60A8\\u51FA\\u793A\\u7684\\u7ADE\\u62CD\\u4EF7\\u683C\",\n            addonAfter: suffixSelector,\n            style: {\n              width: '100%'\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 207,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 197,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(_Form.Item, {\n          name: \"BidSecret\",\n          label: \"\\u52A0\\u5BC6\\u53E3\\u4EE4\",\n          rules: [{\n            required: true,\n            message: '请输入加密口令'\n          }],\n          children: /*#__PURE__*/_jsxDEV(_Input.Password, {\n            placeholder: \"\\u5728\\u4E4B\\u540E\\u7684\\u63ED\\u793A\\u62A5\\u4EF7\\u73AF\\u8282\\u4E2D\\u4F7F\\u7528\\u7684\\u52A0\\u5BC6\\u53E3\\u4EE4\",\n            iconRender: visible => visible ? /*#__PURE__*/_jsxDEV(EyeTwoTone, {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 229,\n              columnNumber: 51\n            }, this) : /*#__PURE__*/_jsxDEV(EyeInvisibleOutlined, {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 229,\n              columnNumber: 68\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 227,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 217,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(_Form.Item, {\n          children: /*#__PURE__*/_jsxDEV(_Button, {\n            //这里不需要 onClick，不然会使函数 onFinishBid 收到参数 SyntheticBaseEvent\n            // onClick={this.onFinishBid}\n            type: \"primary\",\n            htmlType: \"submit\",\n            disabled: this.state.truffleContract === null || this.state.web3 === null,\n            children: \"\\u63D0\\u4EA4\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 233,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 232,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 172,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 158,\n      columnNumber: 13\n    }, this);\n  }\n\n}\n\nexport default Bid;","map":{"version":3,"sources":["/home/kzj/project/finalize/final/code/react_code/src/components/Bid/index.jsx"],"names":["React","Component","UserOutlined","LaptopOutlined","FileSearchOutlined","HomeOutlined","EyeTwoTone","EyeInvisibleOutlined","cookie","getWeb3","getEcommerceStore","saveAccountString","openNotification","Option","suffixSelector","width","Bid","constructor","props","state","username","load","web3","truffleContract","showDrawer","setState","visible","onClose","onFinishFailed","errorInfo","warning","onFinishBid","values","console","log","dir","dataArray","length","error","PriceUnit","undefined","BidAmount","SendAmount","bidPrice","sendPrice","startPrice","originPrice","blockChainID","ID","BidSecret","sealedBid","utils","keccak256","toString","that","deployed","then","i","currentAccount","eth","getAccounts","info","bid","parseInt","from","value","res","success","processTime","err","onFinishFailedBid","render","paddingBottom","required","message"],"mappings":"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","sourcesContent":["import React, {Component} from \"react\";\nimport { Menu, Layout, message, Drawer, Space, Button, Divider, Form, InputNumber, Input, Select } from 'antd';\nimport { UserOutlined, LaptopOutlined, FileSearchOutlined, HomeOutlined, EyeTwoTone, EyeInvisibleOutlined } from '@ant-design/icons';\nimport cookie from \"react-cookies\";\n//接入web3\nimport getWeb3 from \"../../utils/getWeb3\";\nimport getEcommerceStore from \"../../utils/getEcommerceStore\";\n\nimport saveAccountString from \"../../utils/saveAccountString\";\nimport openNotification from \"../Notification\";\n\nconst { Option } = Select;\n\nconst suffixSelector = (\n    <Form.Item name=\"PriceUnit\" noStyle>\n      <Select\n        style={{\n          width: 70,\n        }}\n      >\n        <Option selected=\"selected\" value=\"ETH\">ETH</Option>\n        <Option value=\"wei\">wei</Option>\n      </Select>\n    </Form.Item>\n);\n\n\n\nclass Bid extends Component {\n\n    state = {\n        username:cookie.load('username'),\n        //web3 与 truffleContract 不能作为参数传递到其他路由\n        //BUG\n        web3 : null,\n        truffleContract : null\n    }\n\n    constructor (props) {\n        super (props);\n        // this.changePage = this.changePage.bind(this);\n    }\n\n    showDrawer = () => {\n        this.setState({\n          visible: true,\n        });\n      };\n    \n    onClose = () => {\n        this.setState({\n          visible: false,\n        });\n      };\n\n    //点击提交按钮，表单不能提交时\n    onFinishFailed = (errorInfo) => {\n        message.warning(\"请正确填写商品ID信息\",2);\n    }\n\n    //点击提交竞拍按钮，表单可以提交时\n    onFinishBid = (values) => {\n        console.log(\"竞拍提交按钮被点击，onFinishBid 得到的数据为 : \");\n        console.dir(values);\n        //values 中的数据示意\n        // BidAmount: 1\n        // BidSecret: \"33\"\n        // PriceUnit: \"ETH\"\n        // SendAmount: 2\n\n        if(this.state.dataArray.length === 0){\n            message.error(\"找不到正在竞拍的商品\");\n            return;\n        }\n        if(values.PriceUnit === undefined){\n            message.error(\"请指定价格单位\");\n            return;\n        }\n        //判断是否符合竞拍规则\n        if(values.BidAmount > values.SendAmount){\n            message.error(\"押金低于竞拍价\", 2);\n            return;\n        }\n        //把价格单位换算成wei进行比较，这里的换算写死了，后期改成 web3 中的换算方法\n        console.log(\"竞拍使用的价格单位 : \" + values.PriceUnit);\n        let bidPrice = (values.PriceUnit === \"ETH\") ? (values.BidAmount*1e18) : values.BidAmount;\n        let sendPrice = (values.PriceUnit === \"ETH\") ? (values.SendAmount*1e18) : values.SendAmount;\n        let startPrice = this.state.dataArray[0].originPrice;\n        //startPrice 与 bidPrice 的单位都是 wei\n        console.log(\"起拍价 : \" + startPrice + \", 竞拍价 : \" + bidPrice);\n        if(bidPrice < startPrice){\n            message.error(\"竞拍价低于起拍价\", 2);\n            return;\n        }\n        let blockChainID = this.state.dataArray[0].ID;\n        console.log(\"竞拍商品ID : \" + blockChainID);\n\n        let web3 = this.state.web3;\n\n        //注意这里的解析方式应和合约代码中的对应\n        // let sealedBid = web3.utils.keccak256(web3.utils.toWei(string(amount), 'ether'));\n        //这里传给toWei的第一个参数不要求是字符串类型的，与truffle中使用toWei不同\n        console.log(\"传给keccak256的参数是 \" + (\"\" + bidPrice) + values.BidSecret);\n        //信息加密\n        let sealedBid = web3.utils.keccak256((\"\" + bidPrice) + values.BidSecret).toString('hex');\n        console.log(\"用 keccak256 加密之后 sealedBid = \" + sealedBid);\n\n        //竞价信息上链\n\n        //注意回调函数中的this，和外界的this不同，如果向使用外界的this，要赋值成that传过去\n        //注意要使用async，确保先拿到地址，用await关键字确保运行的先后顺序，再用这个地址调用合约方法\n        let that = this;\n        this.state.truffleContract.deployed().then(async (i) => {\n            console.log(\"进入 this.state.truffleContract.deployed() 的回调函数\");\n            //测试时要在MetaMask中选中ganache提供的10个地址之一，from自己创建的地址会失败\n            //即时获取当前地址，用该地址发交易\n            let currentAccount = await that.state.web3.eth.getAccounts();\n            message.info(\"交易发起地址为: \"+currentAccount, 2);\n            console.log(\"交易发起地址为: \"+currentAccount);\n\n            try{\n                //调用合约的 bid 方法\n                await i.bid(parseInt(blockChainID), sealedBid, { from: currentAccount.toString(), value: sendPrice}).then(res => {\n                    //注意这里调用合约方法使用的地址，必须是字符串形式，要用 toString() 转化为字符串\n                    message.success(\"竞价提交成功\");\n                    console.log(\"成功调用合约的bid方法，返回 : \");\n                    console.dir(res);\n                    //关闭侧边栏\n                    this.onClose();\n                    openNotification(\"竞价提交成功\",\n                                    \"您的报价: \" + values.BidAmount + values.PriceUnit + \", 您的押金: \" + values.SendAmount + values.PriceUnit + \", 距离揭示报价 \" + this.state.dataArray[0].processTime ,\n                                    'bottomLeft');\n                });\n            }catch(err) {\n                message.error(\"向链上提交竞价信息失败\",2);\n                console.log(\"调用合约的bid方法失败 \" + err);\n                return;\n            }  \n        });\n\n    }\n\n\n    //点击提交竞拍按钮，表单不能提交时\n    onFinishFailedBid = (errorInfo) => {\n        message.warning(\"请正确填写竞拍信息\",2);\n    }\n\n   \n\n\n   \n\n \n    \n    render () {\n        return (\n            <Drawer\n          title=\"出示您的报价\"\n          width={400}\n          onClose={this.onClose}\n          visible={this.state.visible}\n          bodyStyle={{ paddingBottom: 80 }}\n          extra={\n            <Space>\n              <Button onClick={this.onClose}>取消</Button>\n            </Space>\n          }\n        >\n            <p>起拍价: <b>{\"productData.price\"}</b></p>\n            <Divider />\n          <Form \n            layout=\"vertical\" hideRequiredMark\n            onFinish={this.onFinishBid}\n            onFinishFailed={this.onFinishFailedBid}\n            \n          >\n            <Form.Item\n                name=\"BidAmount\"\n                label=\"竞拍价格\"\n                rules={[\n                        {\n                            required: true,\n                            message: '请输入竞拍价格',\n                        },\n                ]}\n            >\n            <InputNumber\n                min={0}\n                placeholder=\"竞拍价格不低于起拍价\"\n                addonAfter={suffixSelector}\n                style={{\n                    width: '100%',\n                }}\n            />\n            </Form.Item>\n            <Form.Item\n                name=\"SendAmount\"\n                label=\"竞拍押金\"\n                rules={[\n                        {\n                            required: true,\n                            message: '请输入竞拍押金',\n                        },\n                ]}\n            >\n            <InputNumber\n                min={0}\n                placeholder=\"竞拍押金不低于您出示的竞拍价格\"\n                addonAfter={suffixSelector}\n                style={{\n                    width: '100%',\n                }}\n            />\n            </Form.Item>\n\n            <Form.Item\n                name=\"BidSecret\"\n                label=\"加密口令\"\n                rules={[\n                        {\n                            required: true,\n                            message: '请输入加密口令',\n                        },\n                ]}\n            >\n                <Input.Password\n                placeholder=\"在之后的揭示报价环节中使用的加密口令\"\n                iconRender={visible => (visible ? <EyeTwoTone /> : <EyeInvisibleOutlined />)}\n                />\n            </Form.Item>\n            <Form.Item>\n                <Button \n                //这里不需要 onClick，不然会使函数 onFinishBid 收到参数 SyntheticBaseEvent\n                // onClick={this.onFinishBid}\n                type=\"primary\" \n                htmlType=\"submit\"\n                disabled={ this.state.truffleContract === null || this.state.web3 === null } \n                >\n                提交\n              </Button>\n            </Form.Item>\n\n          </Form>\n        </Drawer>\n        );\n    }\n}\n\nexport default Bid;\n"]},"metadata":{},"sourceType":"module"}