{"ast":null,"code":"import \"antd/es/button/style\";\nimport _Button from \"antd/es/button\";\nimport \"antd/es/table/style\";\nimport _Table from \"antd/es/table\";\nimport \"antd/es/descriptions/style\";\nimport _Descriptions from \"antd/es/descriptions\";\nimport \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport \"antd/es/tag/style\";\nimport _Tag from \"antd/es/tag\";\nvar _jsxFileName = \"/home/kzj/project/finalize/final/code/react_code/src/pages/UserOrAccount/PersonalInfo/index.jsx\";\nimport React, { Component } from 'react';\nimport axios from \"axios\";\nimport cookie from \"react-cookies\";\nimport { Link } from \"react-router-dom\";\nimport timeDuration from \"../../../utils/timeDuration\";\nimport moment from 'moment';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nclass PersonalInfo extends Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      username: cookie.load('username'),\n      email: cookie.load('email'),\n      accountAndLastTimeArray: [],\n      //记录被选中的地址\n      //selectedRowKeys 中的索引下标对应 accountAndLastTimeArray 中的key值，但比index大1，注意拿数据时是用index拿的\n      selectedRowKeys: [],\n      //删除操作进行中\n      loading: false\n    };\n    this.columns = [// {\n    //     title: '设备ID',\n    //     dataIndex: 'deviceID',\n    //     key: 'id',\n    //     render: text => <Link to={{pathname:'/index/editDevice', state:{deviceID:text}}} >{text}</Link>,\n    // },\n    {\n      title: '地址',\n      dataIndex: 'accountString',\n      key: 'accountString'\n    }, {\n      title: '最后上线时间',\n      dataIndex: 'lastTime',\n      key: 'lastTime'\n    }, {\n      title: '状态',\n      key: 'accountStatus',\n      dataIndex: 'accountStatus',\n      render: tag => /*#__PURE__*/_jsxDEV(_Tag, {\n        color: tag === 0 ? 'red' : 'green',\n        children: tag === 0 ? '非活跃' : '活跃'\n      }, tag, false, {\n        fileName: _jsxFileName,\n        lineNumber: 44,\n        columnNumber: 28\n      }, this)\n    }];\n\n    this.deleteAccount = async () => {\n      this.setState({\n        loading: true\n      }); //判断deleteOne 还是 deleteAll\n\n      const allNumber = this.state.accountAndLastTimeArray.length;\n      const deleteNumber = this.state.selectedRowKeys.length;\n      console.log(\"该用户总地址数为 : \" + allNumber);\n      console.log(\"用户要删除的地址数为 : \" + deleteNumber);\n      const isAll = allNumber === deleteNumber ? true : false; //记录数据库是否有变化\n\n      let isChange = false;\n\n      if (isAll) {\n        //删除全部\n        await axios.post(\"/account/deleteAll\", {\n          username: this.state.username\n        }).then(response => {\n          const data = response.data;\n\n          if (data.status === \"success\") {\n            isChange = true;\n            console.log(\"删除该用户所有曾用地址成功\");\n\n            _message.success(\"删除成功\");\n          } else {\n            console.log(\"删除该用户所有曾用地址出错\");\n\n            _message.error(\"删除失败\");\n          }\n        }).catch(err => {\n          console.log(\"数据库操作失败, ERR : \" + err);\n\n          _message.error(\"接入数据库失败\");\n        });\n      } else {\n        //一个一个删\n        let selectIndex;\n        let isSuccess = true; //用这种方法遍历出的值总是从0递增，不满足需要\n        // for(accountKey in this.state.selectedRowKeys) {\n\n        for (selectIndex = 0; selectIndex < deleteNumber; selectIndex += 1) {\n          let accountIndex = this.state.selectedRowKeys[selectIndex] - 1;\n          let accountStringWillDelete = this.state.accountAndLastTimeArray[accountIndex].accountString;\n          console.log(\"正在删除 key = \" + (accountIndex + 1) + \", account = \" + accountStringWillDelete);\n          await axios.post(\"/account/deleteOne\", {\n            username: this.state.username,\n            accountString: accountStringWillDelete\n          }).then(response => {\n            const data = response.data;\n\n            if (data.status === \"success\") {\n              isChange = true;\n              console.log(\"删除该用户的一个地址成功\");\n            } else {\n              console.log(\"删除该用户的一个地址出错\");\n              isSuccess = false;\n            }\n          }).catch(err => {\n            console.log(\"数据库操作失败, ERR : \" + err);\n            isSuccess = false;\n          });\n        } //message 显示成功或失败\n\n\n        if (isSuccess) {\n          _message.success(\"删除成功\");\n        } else {\n          _message.error(\"删除失败或接入数据库失败\");\n        }\n      } //如果删除成功，数据库发生变化，别忘了更新表格\n\n\n      if (isChange) {\n        this.componentDidMount();\n      } //注意 selectedRowKeys 里保存的数据，在数据库操作完成后，才能清空，以为异步执行\n      //要把异步操作转化为顺序操作\n\n\n      setTimeout(async () => {\n        await this.setState({\n          selectedRowKeys: [],\n          loading: false\n        });\n      }, 1000);\n    };\n\n    this.onSelectChange = selectedRowKeys => {\n      console.log('选中项目的编号 : ', selectedRowKeys);\n      this.setState({\n        selectedRowKeys\n      });\n    };\n  }\n\n  //accountAndLastTimeArray 的数据在 componentDidMount 格式化好后，直接传入 render\n  componentDidMount() {\n    const deleteSuccess = cookie.load('deleteSuccess');\n\n    if (deleteSuccess !== undefined) {\n      cookie.remove('deleteSuccess', {\n        path: '/'\n      });\n\n      _message.success('删除地址成功', 2);\n    }\n\n    console.log(\"向后端发起获取所有曾用地址的请求\");\n    axios.post(\"/account/showAll\", {\n      username: this.state.username\n    }).then(response => {\n      const data = response.data;\n\n      if (data.status === \"success\") {\n        console.log(\"获取该用户所有曾用地址成功\"); //data.accountAndLastTime 是外层是数组，每个数组元素是字典类型\n        //map 方法，数组映射\n\n        let array = data.accountAndLastTime.map((item, index) => {\n          //计算时间差，判断是否活跃\n          //注意mysql返回的 timestamp 与js中的 Date 的区别，以及相互转换\n          let timeDifference = new Date() - new Date(item.lastTime);\n          console.log(\"这个日期距离现在已经 \" + timeDuration(timeDifference)); //小于一天时间的是活跃账户\n\n          let tag = timeDifference > 24 * 60 * 60 * 1000 ? true : false;\n          return {\n            //key从1开始\n            key: index + 1,\n            accountString: item.accountString,\n            accountStatus: tag ? 0 : 1,\n            //moment库，格式化时间\n            lastTime: moment(item.lastTime).format('yy年M月D日, h:mm:ss a')\n          };\n        });\n        console.log(\"map映射后的要放到列表中的数据 array 为 : \");\n        console.dir(array);\n        this.setState({\n          accountAndLastTimeArray: array\n        });\n      } else {\n        console.log(\"获取该用户所有曾用地址出错\");\n\n        _message.warning(\"获取地址信息出错\").then(r => console.log(r));\n      }\n    }).catch(err => {\n      console.log(\"发起获取所有曾用地址的请求失败, ERR : \" + err);\n    });\n  }\n\n  render() {\n    const {\n      username,\n      email,\n      accountAndLastTimeArray,\n      loading,\n      selectedRowKeys\n    } = this.state;\n    const rowSelection = {\n      selectedRowKeys,\n      onChange: this.onSelectChange\n    };\n    const hasSelected = selectedRowKeys.length > 0;\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(_Descriptions, {\n        title: \"\\u4E2A\\u4EBA\\u4FE1\\u606F\",\n        bordered: true,\n        column: {\n          xxl: 4,\n          xl: 3,\n          lg: 3,\n          md: 3,\n          sm: 2,\n          xs: 1\n        },\n        children: [/*#__PURE__*/_jsxDEV(_Descriptions.Item, {\n          label: \"\\u7528\\u6237\\u540D\",\n          children: username\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 198,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(_Descriptions.Item, {\n          label: \"\\u90AE\\u7BB1\",\n          children: email\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 199,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 193,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(_Descriptions, {\n        title: \"\\u66FE\\u7528\\u5730\\u5740\\u4FE1\\u606F\",\n        bordered: true,\n        column: {\n          xxl: 4,\n          xl: 3,\n          lg: 3,\n          md: 3,\n          sm: 2,\n          xs: 1\n        },\n        style: {\n          marginTop: '30px'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 201,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(_Table, {\n          rowSelection: rowSelection,\n          columns: this.columns,\n          dataSource: accountAndLastTimeArray\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 210,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            marginBottom: 16\n          },\n          children: [/*#__PURE__*/_jsxDEV(_Button, {\n            type: \"primary\",\n            onClick: this.deleteAccount,\n            disabled: !hasSelected,\n            loading: loading,\n            children: \"\\u5220\\u9664\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 212,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            style: {\n              marginLeft: 8\n            },\n            children: hasSelected ? `选中 ${selectedRowKeys.length} 项` : ''\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 215,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 211,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 209,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 192,\n      columnNumber: 13\n    }, this);\n  }\n\n}\n\nexport default PersonalInfo;","map":{"version":3,"sources":["/home/kzj/project/finalize/final/code/react_code/src/pages/UserOrAccount/PersonalInfo/index.jsx"],"names":["React","Component","axios","cookie","Link","timeDuration","moment","PersonalInfo","state","username","load","email","accountAndLastTimeArray","selectedRowKeys","loading","columns","title","dataIndex","key","render","tag","deleteAccount","setState","allNumber","length","deleteNumber","console","log","isAll","isChange","post","then","response","data","status","success","error","catch","err","selectIndex","isSuccess","accountIndex","accountStringWillDelete","accountString","componentDidMount","setTimeout","onSelectChange","deleteSuccess","undefined","remove","path","array","accountAndLastTime","map","item","index","timeDifference","Date","lastTime","accountStatus","format","dir","warning","r","rowSelection","onChange","hasSelected","xxl","xl","lg","md","sm","xs","marginTop","marginBottom","marginLeft"],"mappings":"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","sourcesContent":["import React, {Component} from 'react';\nimport {Descriptions, message, Button} from 'antd';\nimport axios from \"axios\";\nimport cookie from \"react-cookies\";\nimport { Table, Tag } from 'antd';\nimport {Link} from \"react-router-dom\";\nimport timeDuration from \"../../../utils/timeDuration\";\nimport moment from 'moment';\n\n\nclass PersonalInfo extends Component {\n\n    state = {\n        username:cookie.load('username'),\n        email:cookie.load('email'),\n        accountAndLastTimeArray: [],\n        //记录被选中的地址\n        //selectedRowKeys 中的索引下标对应 accountAndLastTimeArray 中的key值，但比index大1，注意拿数据时是用index拿的\n        selectedRowKeys: [], \n        //删除操作进行中\n        loading: false\n        }\n    columns = [\n        // {\n        //     title: '设备ID',\n        //     dataIndex: 'deviceID',\n        //     key: 'id',\n        //     render: text => <Link to={{pathname:'/index/editDevice', state:{deviceID:text}}} >{text}</Link>,\n        // },\n        {\n            title: '地址',\n            dataIndex: 'accountString',\n            key: 'accountString',\n        },\n        {\n            title: '最后上线时间',\n            dataIndex: 'lastTime',\n            key: 'lastTime',\n        },\n        {\n            title: '状态',\n            key: 'accountStatus',\n            dataIndex: 'accountStatus',\n            render: tag => <Tag color={tag === 0 ? 'red' : 'green'} key={tag}>{tag === 0 ? '非活跃' : '活跃'}</Tag>\n        }\n    ];\n\n    \n    //数据库操作和清空待操作的索引，有先后关系，用同步，避免异步导致bug\n    deleteAccount = async() => {\n        this.setState({ loading: true });\n        //判断deleteOne 还是 deleteAll\n        const allNumber = this.state.accountAndLastTimeArray.length;\n        const deleteNumber = this.state.selectedRowKeys.length;\n        console.log(\"该用户总地址数为 : \" + allNumber);\n        console.log(\"用户要删除的地址数为 : \" + deleteNumber);\n        const isAll = (allNumber === deleteNumber) ? true : false;\n        //记录数据库是否有变化\n        let isChange = false;\n        \n        if(isAll) {\n            //删除全部\n            await axios.post(\"/account/deleteAll\", {\n                username:this.state.username\n            }).then(response => {\n                const data =  response.data;\n                if(data.status === \"success\"){\n                    isChange = true;\n                    console.log(\"删除该用户所有曾用地址成功\");\n                    message.success(\"删除成功\");\n                }else{\n                    console.log(\"删除该用户所有曾用地址出错\");\n                    message.error(\"删除失败\");\n                }\n            }).catch( err => {\n                console.log(\"数据库操作失败, ERR : \" + err);\n                message.error(\"接入数据库失败\");\n            })\n\n        }else{\n            //一个一个删\n            let selectIndex;\n            let isSuccess = true;\n            //用这种方法遍历出的值总是从0递增，不满足需要\n            // for(accountKey in this.state.selectedRowKeys) {\n            for(selectIndex = 0; selectIndex < deleteNumber; selectIndex += 1) {\n                let accountIndex = this.state.selectedRowKeys[selectIndex] -1;\n                let accountStringWillDelete = this.state.accountAndLastTimeArray[accountIndex].accountString;\n                console.log(\"正在删除 key = \" + (accountIndex+1) + \", account = \" + accountStringWillDelete);\n\n                await axios.post(\"/account/deleteOne\", {\n                    username: this.state.username,\n                    accountString: accountStringWillDelete\n                }).then(response => {\n                    const data =  response.data;\n                    if(data.status === \"success\"){\n                        isChange = true;\n                        console.log(\"删除该用户的一个地址成功\");\n                    }else{\n                        console.log(\"删除该用户的一个地址出错\");\n                        isSuccess = false;\n                    }\n                }).catch( err => {\n                    console.log(\"数据库操作失败, ERR : \" + err);\n                    isSuccess = false;\n                })\n            }\n\n            //message 显示成功或失败\n            if(isSuccess){\n                message.success(\"删除成功\");\n            }else{\n                message.error(\"删除失败或接入数据库失败\");\n            }\n        }\n\n        //如果删除成功，数据库发生变化，别忘了更新表格\n        if(isChange){\n            this.componentDidMount();\n        }\n        \n        //注意 selectedRowKeys 里保存的数据，在数据库操作完成后，才能清空，以为异步执行\n        //要把异步操作转化为顺序操作\n        setTimeout(async () => {\n          await this.setState({\n            selectedRowKeys: [],\n            loading: false,\n          });\n        }, 1000);\n\n    };\n\n    onSelectChange = selectedRowKeys => {\n        console.log('选中项目的编号 : ', selectedRowKeys);\n        this.setState({ selectedRowKeys });\n    };\n\n    //accountAndLastTimeArray 的数据在 componentDidMount 格式化好后，直接传入 render\n    componentDidMount () {\n        const deleteSuccess = cookie.load('deleteSuccess');\n        if(deleteSuccess !== undefined){\n            cookie.remove('deleteSuccess', {path:'/'});\n            message.success('删除地址成功',2);\n        }\n        console.log(\"向后端发起获取所有曾用地址的请求\");\n        axios.post(\"/account/showAll\", {\n            username:this.state.username\n        }).then(response => {\n            const data =  response.data;\n            if(data.status === \"success\"){\n                console.log(\"获取该用户所有曾用地址成功\");\n                //data.accountAndLastTime 是外层是数组，每个数组元素是字典类型\n                //map 方法，数组映射\n                let array = data.accountAndLastTime.map((item, index) => {\n                    //计算时间差，判断是否活跃\n                    //注意mysql返回的 timestamp 与js中的 Date 的区别，以及相互转换\n                    let timeDifference = new Date() - new Date(item.lastTime);\n                    console.log(\"这个日期距离现在已经 \" + timeDuration(timeDifference));\n                    //小于一天时间的是活跃账户\n                    let tag = ( timeDifference> 24*60*60*1000) ? true : false;\n                    return {\n                        //key从1开始\n                        key: index + 1,\n                        accountString: item.accountString,\n                        accountStatus: tag ? 0:1,\n                        //moment库，格式化时间\n                        lastTime: moment(item.lastTime).format('yy年M月D日, h:mm:ss a')\n                    }\n                });\n                console.log(\"map映射后的要放到列表中的数据 array 为 : \");\n                console.dir(array);\n                this.setState({accountAndLastTimeArray:array});\n\n            }\n            else{\n                console.log(\"获取该用户所有曾用地址出错\");\n                message.warning (\"获取地址信息出错\").then (r  => console.log(r));\n            }\n        }).catch( err => {\n            console.log(\"发起获取所有曾用地址的请求失败, ERR : \" + err);\n        });\n    }\n\n    render () {\n        const {username, email, accountAndLastTimeArray, loading, selectedRowKeys} = this.state;\n        const rowSelection = {\n            selectedRowKeys,\n            onChange: this.onSelectChange,\n        };\n        const hasSelected = selectedRowKeys.length > 0;\n        return (\n            <div>\n                <Descriptions\n                    title=\"个人信息\"\n                    bordered\n                    column={{ xxl: 4, xl: 3, lg: 3, md: 3, sm: 2, xs: 1 }}\n                >\n                    <Descriptions.Item label=\"用户名\">{username}</Descriptions.Item>\n                    <Descriptions.Item label=\"邮箱\">{email}</Descriptions.Item>\n                </Descriptions>\n                <Descriptions\n                    title=\"曾用地址信息\"\n                    bordered\n                    column={{ xxl: 4, xl: 3, lg: 3, md: 3, sm: 2, xs: 1 }}\n                    style={{marginTop:'30px'}}\n                />\n                \n\n                <div>\n                    <Table rowSelection={rowSelection} columns={this.columns} dataSource={accountAndLastTimeArray} />\n                    <div style={{ marginBottom: 16 }}>\n                        <Button type=\"primary\" onClick={this.deleteAccount} disabled={!hasSelected} loading={loading}>\n                            删除\n                        </Button>\n                        <span style={{ marginLeft: 8 }}>\n                            {hasSelected ? `选中 ${selectedRowKeys.length} 项` : ''}\n                        </span>\n                    </div>\n                </div>\n            </div>\n        );\n    }\n}\n\nexport default PersonalInfo;\n\n\n\n"]},"metadata":{},"sourceType":"module"}