{"ast":null,"code":"import \"antd/es/drawer/style\";\nimport _Drawer from \"antd/es/drawer\";\nimport \"antd/es/input/style\";\nimport _Input from \"antd/es/input\";\nimport \"antd/es/input-number/style\";\nimport _InputNumber from \"antd/es/input-number\";\nimport \"antd/es/divider/style\";\nimport _Divider from \"antd/es/divider\";\nimport \"antd/es/space/style\";\nimport _Space from \"antd/es/space\";\nimport \"antd/es/button/style\";\nimport _Button from \"antd/es/button\";\nimport \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport \"antd/es/form/style\";\nimport _Form from \"antd/es/form\";\nimport \"antd/es/select/style\";\nimport _Select from \"antd/es/select\";\nvar _jsxFileName = \"/home/kzj/project/finalize/final/code/react_code/src/components/Auction/Reveal/index.jsx\";\nimport React, { Component } from \"react\";\nimport { UserOutlined, LaptopOutlined, FileSearchOutlined, HomeOutlined, EyeTwoTone, EyeInvisibleOutlined, RocketOutlined } from '@ant-design/icons';\nimport cookie from \"react-cookies\"; //接入web3\n\nimport getWeb3 from \"../../../utils/getWeb3\";\nimport getEcommerceStore from \"../../../utils/getEcommerceStore\";\nimport openNotification from \"../../Notification\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst {\n  Option\n} = _Select;\n\nconst suffixSelector = /*#__PURE__*/_jsxDEV(_Form.Item, {\n  name: \"PriceUnit\",\n  noStyle: true,\n  children: /*#__PURE__*/_jsxDEV(_Select, {\n    style: {\n      width: 70\n    },\n    children: [/*#__PURE__*/_jsxDEV(Option, {\n      selected: \"selected\",\n      value: \"ETH\",\n      children: \"ETH\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 19,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(Option, {\n      value: \"wei\",\n      children: \"wei\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 14,\n    columnNumber: 7\n  }, this)\n}, void 0, false, {\n  fileName: _jsxFileName,\n  lineNumber: 13,\n  columnNumber: 5\n}, this);\n\nclass Reveal extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      web3: null,\n      truffleContract: null,\n      visible: false\n    };\n\n    this.getBlockChainInfo = async () => {\n      try {\n        const web3 = await getWeb3();\n        const EcommerceStore = await getEcommerceStore(web3);\n        this.setState({\n          web3: web3,\n          truffleContract: EcommerceStore\n        });\n        console.log(\"Reveal 的 web3 : \");\n        console.dir(web3);\n        console.log(\"Reveal 的 EcommerceStore : \");\n        console.dir(this.state.truffleContract);\n        return true;\n      } catch (error) {\n        // Catch any errors for any of the above operations.\n        alert(`[ERROR]接入智能合约失败.`);\n        console.error(error);\n        return false;\n      }\n    };\n\n    this.showDrawer = () => {\n      this.setState({\n        visible: true\n      });\n    };\n\n    this.onClose = () => {\n      this.setState({\n        visible: false\n      });\n    };\n\n    this.onFinishReveal = values => {\n      console.log(\"揭示报价提交按钮被点击，onFinishReveal 得到的数据为 : \");\n      console.dir(values); //values 中的数据示意\n      // BidSecret: \"k10\"\n      // PriceUnit: \"ETH\"\n      // RevealAmount: 4\n\n      if (this.props.dataArray.length === 0) {\n        _message.error(\"找不到正在竞拍的商品\");\n\n        return;\n      }\n\n      if (values.PriceUnit === undefined) {\n        _message.error(\"请指定价格单位\");\n\n        return;\n      } //把价格单位换算成wei进行比较，这里的换算写死了，后期改成 web3 中的换算方法\n\n\n      console.log(\"揭示报价使用的价格单位 : \" + values.PriceUnit); //单位是 wei\n\n      let revealPrice = values.PriceUnit === \"ETH\" ? values.RevealAmount * 1e18 : values.RevealAmount;\n      console.log(\"揭示价 : \" + revealPrice);\n      let blockChainID = this.props.dataArray[0].ID;\n      console.log(\"竞拍商品ID : \" + blockChainID);\n      let web3 = this.state.web3; //这里与 Bid 中的相同部位不同，Bid在这里加密，在传给区块链方法\n      //Reveal 这里不加密，将明文传递给区块链方法\n      //揭示报价信息上链\n\n      let that = this;\n      this.state.truffleContract.deployed().then(async i => {\n        console.log(\"进入 this.state.truffleContract.deployed() 的回调函数\"); //测试时要在MetaMask中选中ganache提供的10个地址之一，from自己创建的地址会失败\n        //即时获取当前地址，用该地址发交易\n\n        let currentAccount = await that.state.web3.eth.getAccounts();\n\n        _message.info(\"交易发起地址为: \" + currentAccount, 2);\n\n        console.log(\"交易发起地址为: \" + currentAccount);\n\n        try {\n          //调用合约的 revealBid 方法\n          await i.revealBid(parseInt(blockChainID), revealPrice.toString(), values.BidSecret, {\n            from: currentAccount.toString(),\n            gas: 440000\n          }).then(res => {\n            //注意这里调用合约方法使用的地址，必须是字符串形式，要用 toString() 转化为字符串\n            _message.success(\"揭示报价成功\");\n\n            console.log(\"成功调用合约的revealBid方法，返回 : \");\n            console.dir(res); //关闭侧边栏\n\n            this.onClose();\n            openNotification(\"揭示报价成功\", \"您的报价: \" + values.RevealAmount + values.PriceUnit + \", 您多余的押金已经退回, 在揭示报价时间截止时, 平台自动使用次高报价, 撮合最高报价者与卖家交易\", 'bottomLeft');\n          });\n        } catch (err) {\n          _message.error(\"向链上提交竞价信息失败\", 2);\n\n          console.log(\"调用合约的revealBid方法失败 \" + err);\n          return;\n        }\n      });\n    };\n\n    this.onFinishFailedReveal = errorInfo => {\n      _message.warning(\"请正确填写竞拍信息\", 2);\n    };\n  }\n\n  //componentWillMount在render之前运行\n  //componentDidMount 在render之后运行\n  //注意先后顺序，this.getBlockChainInfo 在前，that.renderProductDetails 在后\n  async componentDidMount() {\n    // componentWillMount () {\n    console.log(\"生成Reveal模块\");\n\n    if (await this.getBlockChainInfo()) {\n      console.log(\"获得合约信息成功\");\n    } else {\n      console.log(\"获得合约信息失败\");\n    }\n  }\n\n  render() {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      children: this.props.visible ? /*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(_Button, {\n          type: \"primary\",\n          icon: /*#__PURE__*/_jsxDEV(RocketOutlined, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 167,\n            columnNumber: 58\n          }, this),\n          size: \"large\",\n          onClick: this.showDrawer,\n          children: \"\\u63ED\\u793A\\u62A5\\u4EF7\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 167,\n          columnNumber: 29\n        }, this), /*#__PURE__*/_jsxDEV(_Drawer, {\n          title: \"\\u63ED\\u793A\\u60A8\\u7684\\u62A5\\u4EF7\",\n          width: 400,\n          onClose: this.onClose,\n          visible: this.state.visible,\n          bodyStyle: {\n            paddingBottom: 80\n          },\n          extra: /*#__PURE__*/_jsxDEV(_Space, {\n            children: /*#__PURE__*/_jsxDEV(_Button, {\n              onClick: this.onClose,\n              children: \"\\u53D6\\u6D88\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 179,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 178,\n            columnNumber: 13\n          }, this),\n          children: [/*#__PURE__*/_jsxDEV(_Divider, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 183,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(_Form, {\n            layout: \"vertical\",\n            hideRequiredMark: true,\n            onFinish: this.onFinishReveal,\n            onFinishFailed: this.onFinishFailedReveal,\n            children: [/*#__PURE__*/_jsxDEV(_Form.Item, {\n              name: \"RevealAmount\",\n              label: \"\\u63ED\\u793A\\u62A5\\u4EF7\",\n              rules: [{\n                required: true,\n                message: '请揭示竞拍价格'\n              }],\n              children: /*#__PURE__*/_jsxDEV(_InputNumber, {\n                min: 0,\n                placeholder: \"\\u7ADE\\u62CD\\u65F6\\u8F93\\u5165\\u7684\\u4EF7\\u683C\",\n                addonAfter: suffixSelector,\n                style: {\n                  width: '100%'\n                }\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 200,\n                columnNumber: 13\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 190,\n              columnNumber: 13\n            }, this), /*#__PURE__*/_jsxDEV(_Form.Item, {\n              name: \"BidSecret\",\n              label: \"\\u52A0\\u5BC6\\u53E3\\u4EE4\",\n              rules: [{\n                required: true,\n                message: '请与在竞价环节中输入的加密口令一致'\n              }],\n              children: /*#__PURE__*/_jsxDEV(_Input.Password, {\n                placeholder: \"\\u60A8\\u5728\\u7ADE\\u4EF7\\u73AF\\u8282\\u4E2D\\u4F7F\\u7528\\u7684\\u52A0\\u5BC6\\u53E3\\u4EE4\",\n                iconRender: visible => visible ? /*#__PURE__*/_jsxDEV(EyeTwoTone, {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 221,\n                  columnNumber: 51\n                }, this) : /*#__PURE__*/_jsxDEV(EyeInvisibleOutlined, {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 221,\n                  columnNumber: 68\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 219,\n                columnNumber: 17\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 209,\n              columnNumber: 13\n            }, this), /*#__PURE__*/_jsxDEV(_Form.Item, {\n              children: /*#__PURE__*/_jsxDEV(_Button, {\n                type: \"primary\",\n                htmlType: \"submit\",\n                disabled: this.state.truffleContract === null || this.state.web3 === null,\n                children: \"\\u63D0\\u4EA4\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 225,\n                columnNumber: 17\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 224,\n              columnNumber: 13\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 184,\n            columnNumber: 11\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 171,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 166,\n        columnNumber: 25\n      }, this) : null\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 163,\n      columnNumber: 11\n    }, this);\n  }\n\n}\n\nexport default Reveal;","map":{"version":3,"sources":["/home/kzj/project/finalize/final/code/react_code/src/components/Auction/Reveal/index.jsx"],"names":["React","Component","UserOutlined","LaptopOutlined","FileSearchOutlined","HomeOutlined","EyeTwoTone","EyeInvisibleOutlined","RocketOutlined","cookie","getWeb3","getEcommerceStore","openNotification","Option","suffixSelector","width","Reveal","constructor","props","state","web3","truffleContract","visible","getBlockChainInfo","EcommerceStore","setState","console","log","dir","error","alert","showDrawer","onClose","onFinishReveal","values","dataArray","length","PriceUnit","undefined","revealPrice","RevealAmount","blockChainID","ID","that","deployed","then","i","currentAccount","eth","getAccounts","info","revealBid","parseInt","toString","BidSecret","from","gas","res","success","err","onFinishFailedReveal","errorInfo","warning","componentDidMount","render","paddingBottom","required","message"],"mappings":"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","sourcesContent":["import React, {Component} from \"react\";\nimport { Menu, Layout, message, Drawer, Space, Button, Divider, Form, InputNumber, Input, Select } from 'antd';\nimport { UserOutlined, LaptopOutlined, FileSearchOutlined, HomeOutlined, EyeTwoTone, EyeInvisibleOutlined, RocketOutlined } from '@ant-design/icons';\nimport cookie from \"react-cookies\";\n//接入web3\nimport getWeb3 from \"../../../utils/getWeb3\";\nimport getEcommerceStore from \"../../../utils/getEcommerceStore\";\nimport openNotification from \"../../Notification\";\n\nconst { Option } = Select;\n\nconst suffixSelector = (\n    <Form.Item name=\"PriceUnit\" noStyle>\n      <Select\n        style={{\n          width: 70,\n        }}\n      >\n        <Option selected=\"selected\" value=\"ETH\">ETH</Option>\n        <Option value=\"wei\">wei</Option>\n      </Select>\n    </Form.Item>\n);\n\n\n\nclass Reveal extends Component {\n\n    state = {\n        web3 : null,\n        truffleContract : null,\n        visible: false\n    }\n\n    constructor (props) {\n        super (props);\n    }\n\n    getBlockChainInfo = async() => {\n        try{\n            const web3 = await getWeb3();\n            const EcommerceStore = await getEcommerceStore(web3);\n            this.setState({\n                web3: web3,\n                truffleContract:EcommerceStore\n            });\n            console.log(\"Reveal 的 web3 : \");\n            console.dir(web3);\n            console.log(\"Reveal 的 EcommerceStore : \");\n            console.dir(this.state.truffleContract);\n            return true;\n        }catch (error) {\n            // Catch any errors for any of the above operations.\n            alert(\n              `[ERROR]接入智能合约失败.`,\n            );\n            console.error(error);\n            return false;\n          }\n        \n    }\n\n    //componentWillMount在render之前运行\n    //componentDidMount 在render之后运行\n    //注意先后顺序，this.getBlockChainInfo 在前，that.renderProductDetails 在后\n    async componentDidMount () {\n        // componentWillMount () {\n            console.log(\"生成Reveal模块\");\n            if(await this.getBlockChainInfo()){\n                console.log(\"获得合约信息成功\");\n            }else{\n                console.log(\"获得合约信息失败\");\n            }\n        }\n\n    showDrawer = () => {\n        this.setState({\n          visible: true,\n        });\n      };\n    \n    onClose = () => {\n        this.setState({\n          visible: false,\n        });\n      };\n\n    //点击提交竞拍按钮，表单可以提交时\n    onFinishReveal = (values) => {\n        console.log(\"揭示报价提交按钮被点击，onFinishReveal 得到的数据为 : \");\n        console.dir(values);\n        //values 中的数据示意\n        // BidSecret: \"k10\"\n        // PriceUnit: \"ETH\"\n        // RevealAmount: 4\n\n        if(this.props.dataArray.length === 0){\n            message.error(\"找不到正在竞拍的商品\");\n            return;\n        }\n        if(values.PriceUnit === undefined){\n            message.error(\"请指定价格单位\");\n            return;\n        }\n        //把价格单位换算成wei进行比较，这里的换算写死了，后期改成 web3 中的换算方法\n        console.log(\"揭示报价使用的价格单位 : \" + values.PriceUnit);\n        //单位是 wei\n        let revealPrice = (values.PriceUnit === \"ETH\") ? (values.RevealAmount*1e18) : values.RevealAmount;\n        console.log(\"揭示价 : \" + revealPrice);\n        let blockChainID = this.props.dataArray[0].ID;\n        console.log(\"竞拍商品ID : \" + blockChainID);\n\n        let web3 = this.state.web3;\n        //这里与 Bid 中的相同部位不同，Bid在这里加密，在传给区块链方法\n        //Reveal 这里不加密，将明文传递给区块链方法\n\n        //揭示报价信息上链\n        let that = this;\n        this.state.truffleContract.deployed().then(async (i) => {\n            console.log(\"进入 this.state.truffleContract.deployed() 的回调函数\");\n            //测试时要在MetaMask中选中ganache提供的10个地址之一，from自己创建的地址会失败\n            //即时获取当前地址，用该地址发交易\n            let currentAccount = await that.state.web3.eth.getAccounts();\n            message.info(\"交易发起地址为: \"+currentAccount, 2);\n            console.log(\"交易发起地址为: \"+currentAccount);\n\n            try{\n                //调用合约的 revealBid 方法\n                await i.revealBid(parseInt(blockChainID), revealPrice.toString(), values.BidSecret, { from: currentAccount.toString(), gas:440000 }).then(res => {\n                    //注意这里调用合约方法使用的地址，必须是字符串形式，要用 toString() 转化为字符串\n                    message.success(\"揭示报价成功\");\n                    console.log(\"成功调用合约的revealBid方法，返回 : \");\n                    console.dir(res);\n                    //关闭侧边栏\n                    this.onClose();\n                    openNotification(\"揭示报价成功\",\n                                    \"您的报价: \" + values.RevealAmount + values.PriceUnit + \", 您多余的押金已经退回, 在揭示报价时间截止时, 平台自动使用次高报价, 撮合最高报价者与卖家交易\" ,\n                                    'bottomLeft');\n                });\n            }catch(err) {\n                message.error(\"向链上提交竞价信息失败\",2);\n                console.log(\"调用合约的revealBid方法失败 \" + err);\n                return;\n            }  \n        });\n\n    }\n\n\n    //点击提交竞拍按钮，表单不能提交时\n    onFinishFailedReveal = (errorInfo) => {\n        message.warning(\"请正确填写竞拍信息\",2);\n    }\n\n   \n\n \n    \n    render () {\n        return (\n\n\n          <div>\n                {\n                    this.props.visible?(\n                        <div>\n                            <Button type=\"primary\" icon={<RocketOutlined />} size={\"large\"} onClick={this.showDrawer}>\n                揭示报价\n            </Button>\n\n            <Drawer\n          title=\"揭示您的报价\"\n          width={400}\n          onClose={this.onClose}\n          visible={this.state.visible}\n          bodyStyle={{ paddingBottom: 80 }}\n          extra={\n            <Space>\n              <Button onClick={this.onClose}>取消</Button>\n            </Space>\n          }\n        >\n            <Divider />\n          <Form \n            layout=\"vertical\" hideRequiredMark\n            onFinish={this.onFinishReveal}\n            onFinishFailed={this.onFinishFailedReveal}\n            \n          >\n            <Form.Item\n                name=\"RevealAmount\"\n                label=\"揭示报价\"\n                rules={[\n                        {\n                            required: true,\n                            message: '请揭示竞拍价格',\n                        },\n                ]}\n            >\n            <InputNumber\n                min={0}\n                placeholder=\"竞拍时输入的价格\"\n                addonAfter={suffixSelector}\n                style={{\n                    width: '100%',\n                }}\n            />\n            </Form.Item>\n            <Form.Item\n                name=\"BidSecret\"\n                label=\"加密口令\"\n                rules={[\n                        {\n                            required: true,\n                            message: '请与在竞价环节中输入的加密口令一致',\n                        },\n                ]}\n            >\n                <Input.Password\n                placeholder=\"您在竞价环节中使用的加密口令\"\n                iconRender={visible => (visible ? <EyeTwoTone /> : <EyeInvisibleOutlined />)}\n                />\n            </Form.Item>\n            <Form.Item>\n                <Button \n                type=\"primary\" \n                htmlType=\"submit\"\n                disabled={ this.state.truffleContract === null || this.state.web3 === null } \n                >\n                提交\n              </Button>\n            </Form.Item>\n\n          </Form>\n        </Drawer>\n                        </div>\n                    ):null\n                }\n            </div>\n\n            \n        );\n    }\n}\n\nexport default Reveal;\n"]},"metadata":{},"sourceType":"module"}